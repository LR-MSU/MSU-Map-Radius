<!DOCTYPE html><html lang="en"><head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Michigan Counties Map</title> <style> .county { fill: #f0f0f0; stroke: #ffffff; stroke-width: 0.75px; transition: stroke 0.3s, stroke-width 0.3s; } body { overflow-y: hidden; /* Hide vertical scrollbar */ overflow-x: hidden; /* Hide horizontal scrollbar */ } .state { fill: none; stroke: #000000; stroke-width: .5px; } .tooltip { position: absolute; background-color: white; border: 1px solid #ddd; padding: 10px; pointer-events: none; font-family: Arial, sans-serif; font-size: 14px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); opacity: 0; } .tooltip-category { color: #888; font-weight: bold; } .tooltip-value { color: #333; font-weight: bold; } #loading { position: fixed; width: 100vw; height: 100vh; background: white; z-index: 1000; display: none; /* Initially hidden */ justify-content: center; align-items: center; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .spinner { animation: spin 1s linear infinite; } </style> <script src="https://d3js.org/d3.v7.min.js"></script> <script src="https://d3js.org/topojson.v3.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script> <script src="tableau.extensions.1.latest.js"></script></head><body><div id="loading"> <img src="loading.png" class="spinner" alt="Loading..."/></div><svg width="100vw" height="100vh"> <defs> <clipPath id="stateClip"> <path id="state-border"></path> </clipPath> </defs> <g id="mapGroup" clip-path="url(#stateClip)"></g></svg><div id="tooltip" class="tooltip"></div>
<script>
    function showLoading(){d3.select("#loading").style("display","flex")}function hideLoading(){d3.select("#loading").style("display","none")}const svgConst=document.querySelector("svg"),svgRect=svgConst.getBoundingClientRect(),width=svgRect.width,height=svgRect.height,svg=d3.select("svg"),mapGroup=svg.select("#mapGroup"),tooltip=d3.select("#tooltip"),projection=d3.geoMercator().scale(4e3).center([-84.506,44.182]).translate([width/2,height/2]),path=d3.geoPath().projection(projection),zoom=d3.zoom().scaleExtent([1,8]).on("zoom",zoomed);function convertToListOfNamedRows(e){console.time("convertToListOfNamedRows");const{columns:t,data:o}=e,a=t.map((e=>e.fieldName)),n=o.map((e=>Object.fromEntries(a.map(((o,a)=>[o,e[t[a].index]])))));return console.timeEnd("convertToListOfNamedRows"),n}async function getEncodingMap(e){const t=await e.getVisualSpecificationAsync(),o={};if(t.activeMarksSpecificationIndex<0)return o;const a=t.marksSpecifications[t.activeMarksSpecificationIndex];console.time("175-177");for(const e of a.encodings)o[e.id]=e.field;return console.timeEnd("175-177"),o}async function getSummaryDataTable(e){console.time("getSummaryDataTable");const t=await e.getSummaryDataReaderAsync(void 0,{ignoreSelection:!0}),o=[],a=[];for(let e=0;e<t.pageCount;e++)a.push(t.getPageAsync(e));const n=await Promise.all(a);for(const e of n)o.push(...convertToListOfNamedRows(e));return await t.releaseAsync(),console.timeEnd("getSummaryDataTable"),o}function initializeMap(){svg.call(zoom),d3.select("body").on("keydown",(function(e){"Escape"===e.key&&reset()}))}function loadData(){d3.json("cb_201.json").then((e=>{const t=topojson.feature(e,e.objects.cb_2015_us_county_20m).features.filter((e=>"26"===e.properties.STATEFP)),o=topojson.feature(e,e.objects.cb_2018_us_state_20m).features.find((e=>"26"===e.properties.STATEFP));renderMap(t,o),processCircleData(o)}))}function renderMap(e,t){renderCounties(e),renderStateBorder(t)}function renderCounties(e){console.log("Rendering counties..."),console.time("renderCounties"),mapGroup.selectAll(".county").data(e,(e=>e.properties.GEOID)).join((e=>e.append("path").attr("class","county").attr("d",path).attr("id",(e=>`county-${e.properties.GEOID}`)).on("click",clickedCounty).on("mouseover",((e,t)=>requestAnimationFrame((()=>showTooltip(e,t))))).on("mousemove",((e,t)=>requestAnimationFrame((()=>showTooltip(e,t))))).on("mouseout",hideTooltip)),(e=>e.attr("d",path)),(e=>e.remove())),console.timeEnd("renderCounties")}function renderStateBorder(e){console.log("Entered renderStateBorder"),svg.select("#state-border").datum(e).attr("d",path),mapGroup.append("path").datum(e).attr("class","state").attr("d",path).attr("id",`state-${e.properties.GEOID}`)}async function refreshData(e,t,o,a){try{console.log("Entered refreshData"),console.time("refreshData");const[e,n]=await Promise.all([getSummaryDataTable(a),getEncodingMap(a)]),{detail:r,x:s,y:i,x2:l,y2:c}=n,d=r.name,p=s.name,u=i.name,m=l.name,h=c.name,g=e.map((e=>({lat:e[u]?._value,lon:e[p]?._value,id:e[d]?._value}))).filter((({lat:e,lon:t})=>!isNaN(e)&&!isNaN(t)&&isFinite(e)&&isFinite(t)&&e>=-90&&e<=90&&t>=-180&&t<=180));let f=e.map((e=>({lat2:e[h]?._value,lon2:e[m]?._value,id:e[d]?._value}))).filter((({lat2:e,lon2:t})=>!isNaN(e)&&!isNaN(t)&&isFinite(e)&&isFinite(t)&&e>=-90&&e<=90&&t>=-180&&t<=180));const y=new Set(f.map((e=>e.id)));g.forEach((e=>{e.existedInPrior=y.has(e.id)}));const v=new Set(g.map((e=>e.id)));f.forEach((e=>{e.closedInNew=!v.has(e.id)}));const w=[...new Map(g.map((e=>[`${e.lat},${e.lon}`,e]))).values()],A=[...new Map(f.filter((e=>e.closedInNew)).map((e=>[`${e.lat2},${e.lon2}`,e]))).values()];console.timeEnd("refreshData"),console.time("All scripts supposedly"),renderCircles(A,w,t);calculateAreas(w.map((({lat:e,lon:o})=>createCircleGeoJSON(e,o,t))),o),console.timeEnd("All scripts supposedly")}catch(e){console.error("Error in refreshData:",e)}}function processCircleData(e){const t=32.1868,o=[{lat:0,lon:0}].map((e=>createCircleGeoJSON(e.lat,e.lon,t)));console.log("Leading to params");let a=tableau.extensions.worksheetContent.worksheet;refreshData(o,t,e,a)}function calculateAreas(e,t){if(console.log("Entered calculateAreas"),console.time("calculateAreas"),!e||0===e.length)return void console.warn("No circles to process.");const o=new Worker("Worker.js");o.postMessage({dotGeoJSONs:e,michiganBoundary:t}),o.onmessage=function(e){if("results"===e.data.type){console.timeEnd("calculateAreas"),console.log("Worker finished processing");const{totalCircleArea:t,totalIntersectionAreaBeforeUnioning:o,areaOutsideMap:a,finalNonOverlappingArea:n}=e.data.results;console.log(`Total Circle Area: ${t} km²`),console.log(`Overlap Area: ${o} km²`),console.log(`Area Outside Map: ${a} km²`),console.log(`Final Non-Overlapping Area: ${n} km²`),updateTableauParameters(t,o,a,n)}else"log"===e.data.type&&console.log(e.data.message)},o.onerror=function(e){console.error("Worker error:",e.message)}}function renderCircles(e,t,o){console.log("Entered render circles"),console.time("446-453 Send data and recieve back data from worker"),console.time("447- 498 Start to termination of circle worker"),console.timeEnd("446-453 Send data and recieve back data from worker"),console.time("Worker visual response"),t=t.map((e=>({...e,projected:projection([e.lon,e.lat]),path:circlePath(e.lat,e.lon,o,projection)})));const a="#ff55ff",n="#59504e",r="#4bc6b3";mapGroup.selectAll(".circle").data(t.filter((e=>!e.closedInNew))).join("path").attr("class","circle").attr("d",(e=>e.path)).attr("fill","#d3d3d3").style("opacity",1).attr("stroke","#d3d3d3").attr("stroke-width",.5).style("pointer-events","none"),mapGroup.selectAll(".dot").data(t,(e=>e.id)).join((e=>e.append("circle").attr("class","dot").attr("cx",(e=>projection([e.lon,e.lat])[0])).attr("cy",(e=>projection([e.lon,e.lat])[1])).attr("r",3).attr("stroke-width",.5).attr("stroke","#898989")),(e=>e.attr("cx",(e=>projection([e.lon,e.lat])[0])).attr("cy",(e=>projection([e.lon,e.lat])[1]))),(e=>e.remove())).attr("fill",(e=>e.existedInPrior?r:a)),mapGroup.selectAll(".center-dot").data(e).join("circle").attr("class","center-dot").attr("cx",(e=>projection([e.lon2,e.lat2])[0])).attr("cy",(e=>projection([e.lon2,e.lat2])[1])).attr("r",3).attr("fill",(e=>e.closedInNew?n:r)).style("opacity",.75).attr("stroke","#898989").attr("stroke-width",.5),console.timeEnd("Worker visual response"),hideLoading()}function updateTableauParameters(e,t,o,a){console.log("Entered updateTableauParameters"),tableau.extensions.worksheetContent.worksheet.getParametersAsync().then((n=>{console.log(n);let r=n.find((e=>"TotalArea"===e.name)),s=n.find((e=>"OverlapArea"===e.name)),i=n.find((e=>"OutsideMapArea"===e.name)),l=n.find((e=>"FinalArea"===e.name));r.changeValueAsync(parseFloat((.386102*e).toFixed(2))),s.changeValueAsync(parseFloat((.386102*t).toFixed(2))),i.changeValueAsync(parseFloat((.386102*o).toFixed(2))),l.changeValueAsync(parseFloat((.386102*a).toFixed(2)))}))}function zoomed(e){mapGroup.attr("transform",e.transform)}function showTooltip(e,t){tooltip.transition().duration(200).style("opacity",.9),tooltip.html(`\n                <span class="tooltip-category">ISD NAME:</span> <span class="tooltip-value">${t.properties.NAME}</span><br/>\n            `).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px");const o=tooltip.node().getBoundingClientRect(),a=svg.node().getBoundingClientRect();o.right>a.right&&tooltip.style("left",e.pageX-o.width-10+"px"),o.bottom>a.bottom&&tooltip.style("top",e.pageY-o.height-10+"px")}function hideTooltip(){tooltip.transition().duration(500).style("opacity",0)}function circlePath(e,t,o,a){for(var n=[],r=0;r<72;r++)n.push(getDestinationPoint(e,t,5*r,o));if(a){var s=[];for(var r in n)s.push(a([n[r][1],n[r][0]]));return d3.line()(s)+"Z"}return n}function getDestinationPoint(e,t,o,a){var n=6371,r=Math.PI/180,s=180/Math.PI;o*=r,e*=r,t*=r;var i=Math.asin(Math.sin(e)*Math.cos(a/n)+Math.cos(e)*Math.sin(a/n)*Math.cos(o));return[i*s,(t+Math.atan2(Math.sin(o)*Math.sin(a/n)*Math.cos(e),Math.cos(a/n)-Math.sin(e)*Math.sin(i)))*s]}function createCircleGeoJSON(e,t,o){return turf.circle([t,e],o,{steps:64,units:"kilometers"})}function clickedCounty(e,t){const[[o,a],[n,r]]=path.bounds(t);e.stopPropagation(),svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity.translate(width/2,height/2).scale(Math.min(40,.5/Math.max((n-o)/width,(r-a)/height))).translate(-(o+n)/2,-(a+r)/2))}function reset(){svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity,d3.zoomTransform(svg.node()).invert([width/2,height/2]))}function Start(){initializeMap(),loadData(),showLoading()}window.onload=tableau.extensions.initializeAsync().then((async()=>{tableau.extensions.worksheetContent.worksheet.addEventListener(tableau.TableauEventType.SummaryDataChanged,Start),Start()})).catch((e=>{console.log(e.stack||e)}));</script></body></html>