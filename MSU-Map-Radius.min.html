<!DOCTYPE html><html lang="en"><head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Michigan Counties Map</title> <style> .county { fill: #f0f0f0; stroke: #ffffff; stroke-width: 0.75px; transition: stroke 0.3s, stroke-width 0.3s; } body { overflow-y: hidden; /* Hide vertical scrollbar */ overflow-x: hidden; /* Hide horizontal scrollbar */ } .state { fill: none; stroke: #000000; stroke-width: .5px; } .tooltip { position: absolute; background-color: white; border: 1px solid #ddd; padding: 10px; pointer-events: none; font-family: Arial, sans-serif; font-size: 14px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); opacity: 0; } .tooltip-category { color: #888; font-weight: bold; } .tooltip-value { color: #333; font-weight: bold; } #loading { position: fixed; width: 100vw; height: 100vh; background: white; z-index: 1000; display: none; /* Initially hidden */ justify-content: center; align-items: center; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .spinner { animation: spin 1s linear infinite; } </style> <script src="https://d3js.org/d3.v7.min.js"></script> <script src="https://d3js.org/topojson.v3.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script> <script src="tableau.extensions.1.latest.js"></script></head><body><div id="loading"> <img src="loading.png" class="spinner" alt="Loading..."/></div><svg width="100vw" height="100vh"> <defs> <clipPath id="stateClip"> <path id="state-border"></path> </clipPath> </defs> <g id="mapGroup" clip-path="url(#stateClip)"></g></svg><div id="tooltip" class="tooltip"></div><script> function showLoading(){d3.select("#loading").style("display","flex")}function hideLoading(){d3.select("#loading").style("display","none")}const svgConst=document.querySelector("svg"),svgRect=svgConst.getBoundingClientRect(),width=svgRect.width,height=svgRect.height,svg=d3.select("svg"),mapGroup=svg.select("#mapGroup"),tooltip=d3.select("#tooltip"),projection=d3.geoMercator().scale(4e3).center([-84.506,44.182]).translate([width/2,height/2]),path=d3.geoPath().projection(projection),zoom=d3.zoom().scaleExtent([1,8]).on("zoom",zoomed);function convertToListOfNamedRows(e){console.time("convertToListOfNamedRows");let{columns:t,data:a}=e,o=t.map(e=>e.fieldName),n=a.map(e=>Object.fromEntries(o.map((a,o)=>[a,e[t[o].index]])));return console.timeEnd("convertToListOfNamedRows"),n}async function getEncodingMap(e){let t=await e.getVisualSpecificationAsync(),a={};if(t.activeMarksSpecificationIndex<0)return a;let o=t.marksSpecifications[t.activeMarksSpecificationIndex];for(let n of(console.time("175-177"),o.encodings))a[n.id]=n.field;return console.timeEnd("175-177"),a}async function getSummaryDataTable(e){console.time("getSummaryDataTable");let t=await e.getSummaryDataReaderAsync(void 0,{ignoreSelection:!0}),a=[],o=[];for(let n=0;n<t.pageCount;n++)o.push(t.getPageAsync(n));let r=await Promise.all(o);for(let i of r)a.push(...convertToListOfNamedRows(i));return await t.releaseAsync(),console.timeEnd("getSummaryDataTable"),a}function initializeMap(){svg.call(zoom),d3.select("body").on("keydown",function(e){"Escape"===e.key&&reset()})}function loadData(){d3.json("cb_201.json").then(e=>{let t=topojson.feature(e,e.objects.cb_2015_us_county_20m).features.filter(e=>"26"===e.properties.STATEFP),a=topojson.feature(e,e.objects.cb_2018_us_state_20m).features.find(e=>"26"===e.properties.STATEFP);renderMap(t,a),processCircleData(a)})}function renderMap(e,t){renderCounties(e),renderStateBorder(t)}function renderCounties(e){console.log("Rendering counties..."),console.time("renderCounties"),mapGroup.selectAll(".county").data(e,e=>e.properties.GEOID).join(e=>e.append("path").attr("class","county").attr("d",path).attr("id",e=>`county-${e.properties.GEOID}`).on("click",clickedCounty).on("mouseover",(e,t)=>requestAnimationFrame(()=>showTooltip(e,t))).on("mousemove",(e,t)=>requestAnimationFrame(()=>showTooltip(e,t))).on("mouseout",hideTooltip),e=>e.attr("d",path),e=>e.remove()),console.timeEnd("renderCounties")}function renderStateBorder(e){console.log("Entered renderStateBorder"),svg.select("#state-border").datum(e).attr("d",path),mapGroup.append("path").datum(e).attr("class","state").attr("d",path).attr("id",`state-${e.properties.GEOID}`)}async function refreshData(e,t,a,o){try{console.log("Entered refreshData"),console.time("refreshData");let[n,r]=await Promise.all([getSummaryDataTable(o),getEncodingMap(o)]),{detail:i,x:s,y:l,x2:c,y2:d}=r,p=i.name,u=s.name,m=l.name,g=c.name,f=d.name,h=n.map(e=>({lat:e[m]?._value,lon:e[u]?._value,id:e[p]?._value})).filter(({lat:e,lon:t})=>!isNaN(e)&&!isNaN(t)&&isFinite(e)&&isFinite(t)&&e>=-90&&e<=90&&t>=-180&&t<=180),y=n.map(e=>({lat2:e[f]?._value,lon2:e[g]?._value,id:e[p]?._value})).filter(({lat2:e,lon2:t})=>!isNaN(e)&&!isNaN(t)&&isFinite(e)&&isFinite(t)&&e>=-90&&e<=90&&t>=-180&&t<=180),$=new Set(y.map(e=>e.id));h.forEach(e=>{e.existedInPrior=$.has(e.id)});let v=new Set(h.map(e=>e.id));y.forEach(e=>{e.closedInNew=!v.has(e.id)});let w=[...new Map(h.map(e=>[`${e.lat},${e.lon}`,e])).values()],k=[...new Map(y.map(e=>[`${e.lat2},${e.lon2}`,e])).values()];console.timeEnd("refreshData"),console.time("All scripts supposedly"),renderCircles(k,w,t);let A=w.map(({lat:e,lon:a})=>createCircleGeoJSON(e,a,t));calculateAreas(A,a),console.timeEnd("All scripts supposedly")}catch(_){console.error("Error in refreshData:",_)}}function processCircleData(e){let t=[{lat:0,lon:0}].map(e=>createCircleGeoJSON(e.lat,e.lon,32.1868));console.log("Leading to params");refreshData(t,32.1868,e,tableau.extensions.worksheetContent.worksheet)}function calculateAreas(e,t){if(console.log("Entered calculateAreas",e),console.time("calculateAreas"),!e||0===e.length){console.warn("No circles to process.");return}let a=new Worker("Worker.js");a.postMessage({dotGeoJSONs:e,michiganBoundary:t}),a.onmessage=function(e){if("results"===e.data.type){console.timeEnd("calculateAreas"),console.log("Worker finished processing");let{totalCircleArea:t,totalIntersectionAreaBeforeUnioning:a,areaOutsideMap:o,finalNonOverlappingArea:n}=e.data.results;console.log(`Total Circle Area: ${t} km\xb2`),console.log(`Overlap Area: ${a} km\xb2`),console.log(`Area Outside Map: ${o} km\xb2`),console.log(`Final Non-Overlapping Area: ${n} km\xb2`),updateTableauParameters(t,a,o,n)}else"log"===e.data.type&&console.log(e.data.message)},a.onerror=function(e){console.error("Worker error:",e.message)}}function renderCircles(e,t,a){console.log("Entered rendercircles"),console.time("446-453 Send data and recieve back data from worker"),console.time("447- 498 Start to termination of circle worker"),console.timeEnd("446-453 Send data and recieve back data from worker"),console.time("Worker visual response"),t=t.map(e=>({...e,projected:projection([e.lon,e.lat]),path:circlePath(e.lat,e.lon,a,projection)}));let o={new:"#ff55ff",closed:"#59504e",same:"#4bc6b3"};console.log("test"),mapGroup.selectAll(".circle").data(t.filter(e=>!e.closedInNew)).join("path").attr("class","circle").attr("d",e=>e.path).attr("fill","#d3d3d3").style("opacity",1).attr("stroke","#d3d3d3").attr("stroke-width",.5).style("pointer-events","none"),console.log("test2"),mapGroup.selectAll(".center-dot").data(e).join("circle").attr("class","center-dot").attr("d",e=>e.path).attr("r",3).attr("fill",e=>e.closedInNew?o.closed:o.same).style("opacity",.75).attr("stroke","#898989").attr("stroke-width",.5),console.log("test3"),mapGroup.selectAll(".dot").data(t,e=>e.id).join(e=>e.append("circle").attr("class","dot").attr("cx",e=>projection([e.lon,e.lat])[0]).attr("cy",e=>projection([e.lon,e.lat])[1]).attr("r",3).attr("stroke-width",.5).attr("stroke","#898989"),e=>e.attr("cx",e=>projection([e.lon,e.lat])[0]).attr("cy",e=>projection([e.lon,e.lat])[1]),e=>e.remove()).attr("fill",e=>e.existedInPrior?o.same:o.new),console.log("test4"),console.timeEnd("Worker visual response"),hideLoading()}function updateTableauParameters(e,t,a,o){console.log("Entered updateTableauParameters");tableau.extensions.worksheetContent.worksheet.getParametersAsync().then(n=>{console.log(n);let r=n.find(e=>"TotalArea"===e.name),i=n.find(e=>"OverlapArea"===e.name),s=n.find(e=>"OutsideMapArea"===e.name),l=n.find(e=>"FinalArea"===e.name);r.changeValueAsync(parseFloat((.386102*e).toFixed(2))),i.changeValueAsync(parseFloat((.386102*t).toFixed(2))),s.changeValueAsync(parseFloat((.386102*a).toFixed(2))),l.changeValueAsync(parseFloat((.386102*o).toFixed(2)))})}function zoomed(e){mapGroup.attr("transform",e.transform)}function showTooltip(e,t){tooltip.transition().duration(200).style("opacity",.9),tooltip.html(` <span class="tooltip-category">ISD NAME:</span> <span class="tooltip-value">${t.properties.NAME}</span><br/> `).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px");let a=tooltip.node(),o=a.getBoundingClientRect(),n=svg.node().getBoundingClientRect();o.right>n.right&&tooltip.style("left",e.pageX-o.width-10+"px"),o.bottom>n.bottom&&tooltip.style("top",e.pageY-o.height-10+"px")}function hideTooltip(){tooltip.transition().duration(500).style("opacity",0)}function circlePath(e,t,a,o){for(var n=[],r=0;r<72;r++)n.push(getDestinationPoint(e,t,5*r,a));if(!o)return n;var i=[];for(var r in n)i.push(o([n[r][1],n[r][0]]));return d3.line()(i)+"Z"}function getDestinationPoint(e,t,a,o){var n=Math.PI/180,r=180/Math.PI;a*=n;var i=Math.asin(Math.sin(e*=n)*Math.cos(o/6371)+Math.cos(e)*Math.sin(o/6371)*Math.cos(a)),s=(t*=n)+Math.atan2(Math.sin(a)*Math.sin(o/6371)*Math.cos(e),Math.cos(o/6371)-Math.sin(e)*Math.sin(i));return[i*r,s*r]}function createCircleGeoJSON(e,t,a){return turf.circle([t,e],a,{steps:64,units:"kilometers"})}function clickedCounty(e,t){let[[a,o],[n,r]]=path.bounds(t);e.stopPropagation(),svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity.translate(width/2,height/2).scale(Math.min(40,.5/Math.max((n-a)/width,(r-o)/height))).translate(-(a+n)/2,-(o+r)/2))}function reset(){svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity,d3.zoomTransform(svg.node()).invert([width/2,height/2]))}function Start(){initializeMap(),loadData(),showLoading()}window.onload=tableau.extensions.initializeAsync().then(async()=>{tableau.extensions.worksheetContent.worksheet.addEventListener(tableau.TableauEventType.SummaryDataChanged,Start),Start()}).catch(e=>{console.log(e.stack||e)});</script></body></html>