<!doctypehtml><html lang=en><meta charset=UTF-8><meta content="width=device-width,initial-scale=1"name=viewport><title>Michigan Counties Map</title><style>.circle{fill:#e6e6e6;stroke:#e6e6e6;stroke-width:.5;opacity:1;pointer-events:none}.center-dot,.dot{stroke:#898989;stroke-width:.5}.center-dot{opacity:.75}.current-same,.prior-same{fill:#59c18f}.prior-closed{fill:#fff}.current-new{fill:#684183}.county{fill-opacity:0;stroke:#000;stroke-width:1px;transition:stroke .3s,stroke-width .3s}body{overflow-y:hidden;overflow-x:hidden}.state{fill:none;stroke:#000;stroke-width:1px}.tooltip{position:absolute;background-color:#fff;border:1px solid #ddd;padding:10px;pointer-events:none;font-family:Arial,sans-serif;font-size:14px;box-shadow:0 0 10px rgba(0,0,0,.1);opacity:0}.tooltip-category{color:#888;font-weight:700}.tooltip-value{color:#333;font-weight:700}#loading{position:fixed;width:100vw;height:100vh;background:#fff;z-index:1000;display:none;justify-content:center;align-items:center}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.spinner{animation:spin 1s linear infinite}</style><script src=https://d3js.org/d3.v7.min.js></script><script src=https://d3js.org/topojson.v3.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js></script><script src=../../assets/tableau.extensions.1.latest.js></script><div id=loading><img alt=Loading... class=spinner src=../../assets/loading.png></div><svg height=100vh width=100vw><defs><clipPath id=stateClip><path id=state-border></path></clipPath></defs><g id=mapGroup clip-path=url(#stateClip)><g id=dotsLayer></g><g id=bordersLayer></g></g></svg><div id=tooltip class=tooltip></div><script>
    function showLoading(){d3.select("#loading").style("display","flex")}function hideLoading(){d3.select("#loading").style("display","none")}const svgConst=document.querySelector("svg"),svgRect=svgConst.getBoundingClientRect(),width=svgRect.width,height=svgRect.height,svg=d3.select("svg"),mapGroup=svg.select("#mapGroup"),tooltip=d3.select("#tooltip"),projection=d3.geoMercator().scale(4e3).center([-84.506,44.182]).translate([width/2,height/2]),path=d3.geoPath().projection(projection),zoom=d3.zoom().scaleExtent([1,8]).on("zoom",zoomed);function convertToListOfNamedRows(e){console.time("convertToListOfNamedRows");let{columns:t,data:a}=e,o=t.map(e=>e.fieldName),r=a.map(e=>Object.fromEntries(o.map((a,o)=>[a,e[t[o].index]])));return console.timeEnd("convertToListOfNamedRows"),r}async function getEncodingMap(e){let t=await e.getVisualSpecificationAsync(),a={};if(t.activeMarksSpecificationIndex<0)return a;let o=t.marksSpecifications[t.activeMarksSpecificationIndex];for(let r of(console.time("175-177"),o.encodings))a[r.id]=r.field;return console.timeEnd("175-177"),a}async function getSummaryDataTable(e){console.time("getSummaryDataTable");let t=await e.getSummaryDataReaderAsync(void 0,{ignoreSelection:!0}),a=[],o=[];for(let r=0;r<t.pageCount;r++)o.push(t.getPageAsync(r));let n=await Promise.all(o);for(let i of n)a.push(...convertToListOfNamedRows(i));return await t.releaseAsync(),console.timeEnd("getSummaryDataTable"),a}function initializeMap(){svg.call(zoom),d3.select("body").on("keydown",function(e){"Escape"===e.key&&reset()})}function loadData(){d3.json("../../assets/michiganCountyGeo.json").then(e=>{let t=topojson.feature(e,e.objects.cb_2015_us_county_20m).features.filter(e=>"26"===e.properties.STATEFP),a=topojson.feature(e,e.objects.cb_2018_us_state_20m).features.find(e=>"26"===e.properties.STATEFP);renderMap(t,a),processCircleData(a)})}function renderMap(e,t){renderCounties(e),renderStateBorder(t)}function renderCounties(e){console.log("Rendering counties..."),console.time("renderCounties");let t=d3.select("#bordersLayer");t.selectAll(".county").data(e,e=>e.properties.GEOID).join(e=>e.append("path").attr("class","county").attr("d",path).attr("id",e=>`county-${e.properties.GEOID}`).on("click",clickedCounty).on("mouseover",(e,t)=>requestAnimationFrame(()=>showTooltip(e,t))).on("mousemove",(e,t)=>requestAnimationFrame(()=>showTooltip(e,t))).on("mouseout",hideTooltip),e=>e.attr("d",path),e=>e.remove()),console.timeEnd("renderCounties")}function renderStateBorder(e){console.log("Entered renderStateBorder"),svg.select("#state-border").datum(e).attr("d",path),d3.select("#bordersLayer").append("path").datum(e).attr("class","state").attr("d",path).attr("id",`state-${e.properties.GEOID}`)}async function refreshData(e,t,a,o){try{console.log("Entered refreshData"),console.time("refreshData");let[r,n]=await Promise.all([getSummaryDataTable(o),getEncodingMap(o)]),{detail:i,x:s,y:l,x2:c,y2:d}=n,p=i.name,u=s.name,m=l.name,g=c.name,f=d.name,h=[],y=[],$=new Set,v=new Set;for(let w of r){let A=w[p]?._value,k=w[m]?._value,C=w[u]?._value;S(k,C)&&(h.push({lat:k,lon:C,id:A}),v.add(A));let E=w[f]?._value,_=w[g]?._value;S(E,_)&&(y.push({lat2:E,lon2:_,id:A}),$.add(A))}function S(e,t){return isFinite(e)&&isFinite(t)&&e>=-90&&e<=90&&t>=-180&&t<=180}h.forEach(e=>{e.existedInPrior=$.has(e.id)}),y.forEach(e=>{e.closedInNew=!v.has(e.id)});let j=b(h,"lat","lon"),x=b(y.filter(e=>e.closedInNew),"lat2","lon2");console.timeEnd("refreshData"),console.time("All scripts supposedly"),renderCircles(x,j,t);let T=j.map(({lat:e,lon:a})=>createCircleGeoJSON(e,a,t));function b(e,t,a){let o=new Map;for(let r of e){let n=`${r[t]},${r[a]}`;o.has(n)||o.set(n,r)}return Array.from(o.values())}calculateAreas(T,a),console.timeEnd("All scripts supposedly")}catch(D){console.error("Error in refreshData:",D)}}function processCircleData(e){let t=[{lat:0,lon:0}].map(e=>createCircleGeoJSON(e.lat,e.lon,32.1868));console.log("Leading to params");refreshData(t,32.1868,e,tableau.extensions.worksheetContent.worksheet)}function calculateAreas(e,t){if(console.log("Entered calculateAreas"),console.time("calculateAreas"),!e||0===e.length){console.warn("No circles to process.");return}let a=new Worker("../../assets/Worker.js");a.postMessage({dotGeoJSONs:e,michiganBoundary:t}),a.onmessage=function(e){if("results"===e.data.type){console.timeEnd("calculateAreas"),console.log("Worker finished processing");let{totalCircleArea:t,totalIntersectionAreaBeforeUnioning:a,areaOutsideMap:o,finalNonOverlappingArea:r}=e.data.results;console.log(`Total Circle Area: ${t} km\xb2`),console.log(`Overlap Area: ${a} km\xb2`),console.log(`Area Outside Map: ${o} km\xb2`),console.log(`Final Non-Overlapping Area: ${r} km\xb2`),updateTableauParameters(t,a,o,r)}else"log"===e.data.type&&console.log(e.data.message)},a.onerror=function(e){console.error("Worker error:",e.message)}}function renderCircles(e,t,a){console.log("Entered render circles"),console.time("446-453 Send data and recieve back data from worker"),console.time("447- 498 Start to termination of circle worker"),console.timeEnd("446-453 Send data and recieve back data from worker"),console.time("Worker visual response");let o=d3.select("#dotsLayer");t=t.map(e=>{let t=projection([e.lon,e.lat]);return{...e,projected:t,path:circlePath(e.lat,e.lon,a,projection)}}),e=e.map(e=>{let t=projection([e.lon2,e.lat2]);return{...e,projectedCenter:t}});let r=e.filter(e=>!e.closedInNew),n=e.filter(e=>e.closedInNew),i=t.filter(e=>e.existedInPrior),s=t.filter(e=>!e.existedInPrior);o.selectAll(".circle").data([...i,...s].filter(e=>!e.closedInNew)).join("path").attr("class","circle").attr("d",e=>e.path),o.selectAll(".center-dot.prior-same").data(r,e=>e.id).join("circle").attr("class","center-dot prior-same").attr("cx",e=>e.projectedCenter[0]).attr("cy",e=>e.projectedCenter[1]),o.selectAll(".dot.current-same").data(i,e=>e.id).join("circle").attr("class","dot current-same").attr("cx",e=>e.projected[0]).attr("cy",e=>e.projected[1]),o.selectAll(".center-dot.prior-closed").data(n,e=>e.id).join("circle").attr("class","center-dot prior-closed").attr("cx",e=>e.projectedCenter[0]).attr("cy",e=>e.projectedCenter[1]),o.selectAll(".dot.current-new").data(s,e=>e.id).join("circle").attr("class","dot current-new").attr("cx",e=>e.projected[0]).attr("cy",e=>e.projected[1]),console.timeEnd("Worker visual response"),hideLoading()}function updateTableauParameters(e,t,a,o){console.log("Entered updateTableauParameters");tableau.extensions.worksheetContent.worksheet.getParametersAsync().then(r=>{console.log(r);let n=r.find(e=>"TotalArea"===e.name),i=r.find(e=>"OverlapArea"===e.name),s=r.find(e=>"OutsideMapArea"===e.name),l=r.find(e=>"FinalArea"===e.name);n.changeValueAsync(parseFloat((.386102*e).toFixed(2))),i.changeValueAsync(parseFloat((.386102*t).toFixed(2))),s.changeValueAsync(parseFloat((.386102*a).toFixed(2))),l.changeValueAsync(parseFloat((.386102*o).toFixed(2)))})}function zoomed(e){mapGroup.attr("transform",e.transform)}function showTooltip(e,t){tooltip.transition().duration(200).style("opacity",.9),tooltip.html(`
                <span class="tooltip-category">County Name:</span> <span class="tooltip-value">${t.properties.NAME}</span><br/>
            `).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px");let a=tooltip.node(),o=a.getBoundingClientRect(),r=svg.node().getBoundingClientRect();o.right>r.right&&tooltip.style("left",e.pageX-o.width-10+"px"),o.bottom>r.bottom&&tooltip.style("top",e.pageY-o.height-10+"px")}function hideTooltip(){tooltip.transition().duration(500).style("opacity",0)}function circlePath(e,t,a,o){for(var r=[],n=0;n<72;n++)r.push(getDestinationPoint(e,t,5*n,a));if(!o)return r;var i=[];for(var n in r)i.push(o([r[n][1],r[n][0]]));return d3.line()(i)+"Z"}function getDestinationPoint(e,t,a,o){var r=Math.PI/180,n=180/Math.PI;a*=r;var i=Math.asin(Math.sin(e*=r)*Math.cos(o/6371)+Math.cos(e)*Math.sin(o/6371)*Math.cos(a)),s=(t*=r)+Math.atan2(Math.sin(a)*Math.sin(o/6371)*Math.cos(e),Math.cos(o/6371)-Math.sin(e)*Math.sin(i));return[i*n,s*n]}function createCircleGeoJSON(e,t,a){return turf.circle([t,e],a,{steps:64,units:"kilometers"})}function clickedCounty(e,t){let[[a,o],[r,n]]=path.bounds(t);e.stopPropagation(),svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity.translate(width/2,height/2).scale(Math.min(40,.5/Math.max((r-a)/width,(n-o)/height))).translate(-(a+r)/2,-(o+n)/2))}function reset(){svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity,d3.zoomTransform(svg.node()).invert([width/2,height/2]))}function Start(){initializeMap(),loadData(),showLoading()}window.onload=tableau.extensions.initializeAsync().then(async()=>{tableau.extensions.worksheetContent.worksheet.addEventListener(tableau.TableauEventType.SummaryDataChanged,Start),Start()}).catch(e=>{console.log(e.stack||e)});
</script></body></html>
