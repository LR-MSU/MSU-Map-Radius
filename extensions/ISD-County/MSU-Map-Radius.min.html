<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta content="width=device-width, initial-scale=1.0" name=viewport><title>Michigan Counties Map</title><style>.circle{fill:#e6e6e6;stroke:#e6e6e6;stroke-width:.5;opacity:1;pointer-events:none}.dot,.center-dot{stroke:#898989;stroke-width:.5;r:3}.center-dot{opacity:1}.prior-same,.current-same{fill:#59c18f}.prior-closed{fill:#fff}.current-new{fill:#684183}.ISD{fill-opacity:0;stroke:#000;stroke-width:1px;transition:stroke .3s,stroke-width .3s}body{overflow-y:hidden;overflow-x:hidden}.state{fill:none;stroke:#000;stroke-width:1px}.tooltip{position:absolute;background-color:white;border:1px solid #ddd;padding:10px;pointer-events:none;font-family:Arial,sans-serif;font-size:14px;box-shadow:0 0 10px rgba(0,0,0,0.1);opacity:0}.tooltip-category{color:#888;font-weight:bold}.tooltip-value{color:#333;font-weight:bold}#loading{position:fixed;width:100vw;height:100vh;background:white;z-index:1000;display:none;justify-content:center;align-items:center}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.spinner{animation:spin 1s linear infinite}</style><script src=https://d3js.org/d3.v7.min.js></script><script src=https://d3js.org/topojson.v3.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js></script><script src=../../assets/tableau.extensions.1.latest.js></script></head><body><div id=loading><img alt=Loading... class=spinner src=../../assets/loading.png></div><svg height=100vh width=100vw><defs><clippath id=stateClip><path id=state-border></path></clippath></defs><g clip-path=url(#stateClip) id=mapGroup><g id=circlesLayer></g><g id=bordersLayer></g><g id=dotsLayer></g></g></svg><div class=tooltip id=tooltip></div><script>function showLoading(){d3.select("#loading").style("display","flex");}
function hideLoading(){d3.select("#loading").style("display","none");}
const svgConst=document.querySelector('svg');const svgRect=svgConst.getBoundingClientRect();const width=svgRect.width;const height=svgRect.height;const svg=d3.select("svg");const mapGroup=svg.select("#mapGroup");const tooltip=d3.select("#tooltip");const projection=d3.geoMercator().scale(4000).center([-84.506,44.182]).translate([width/2,height/2]);const path=d3.geoPath().projection(projection);const zoom=d3.zoom().scaleExtent([1,8]).on("zoom",zoomed);function convertToListOfNamedRows(dataTablePage){console.time('convertToListOfNamedRows');const{columns,data}=dataTablePage;const columnMap=columns.map(col=>col.fieldName);const rows=data.map(row=>Object.fromEntries(columnMap.map((key,index)=>[key,row[columns[index].index]])));console.timeEnd('convertToListOfNamedRows');return rows;}
async function getEncodingMap(worksheet){const visualSpec=await worksheet.getVisualSpecificationAsync();const encodingMap={};if(visualSpec.activeMarksSpecificationIndex<0)return encodingMap;const marksCard=visualSpec.marksSpecifications[visualSpec.activeMarksSpecificationIndex];console.time('175-177')
for(const encoding of marksCard.encodings){encodingMap[encoding.id]=encoding.field;}
console.timeEnd('175-177')
return encodingMap;}
async function getSummaryDataTable(worksheet){console.time('getSummaryDataTable');const dataTableReader=await worksheet.getSummaryDataReaderAsync(undefined,{ignoreSelection:true});const rows=[];const pagePromises=[];for(let currentPage=0;currentPage<dataTableReader.pageCount;currentPage++){pagePromises.push(dataTableReader.getPageAsync(currentPage));}
const pages=await Promise.all(pagePromises);for(const dataTablePage of pages){rows.push(...convertToListOfNamedRows(dataTablePage));}
await dataTableReader.releaseAsync();console.timeEnd('getSummaryDataTable');return rows;}
function initializeMap(){svg.call(zoom);d3.select("body").on("keydown",function(event){if(event.key==="Escape"){reset();}});}
function loadData(){d3.json("../../assets/michiganCountytoISDGeo.json").then(data=>{const michiganState=data.features.find(d=>{console.log(d.properties)
return d.properties.ISDName==="Michigan";})
const michiganCounties=data.features.filter(d=>{return d.properties.ISDName!=="Michigan";});console.log(michiganCounties,michiganState)
renderMap(michiganCounties,michiganState);processCircleData(michiganState);});}
function renderMap(michiganCounties,michiganState){renderCounties(michiganCounties);renderStateBorder(michiganState);}
function renderCounties(michiganCounties){console.log("Rendering counties...");console.time("renderCounties");const bordersLayer=d3.select("#bordersLayer");bordersLayer.selectAll(".ISD").data(michiganCounties,d=>d.properties.OBJECTID).join(enter=>enter.append("path").attr("class","ISD").attr("d",path).attr("id",d=>`ISD-${d.properties.OBJECTID}`).on("click",clickedISD).on("mouseover",(event,d)=>requestAnimationFrame(()=>showTooltip(event,d))).on("mousemove",(event,d)=>requestAnimationFrame(()=>showTooltip(event,d))).on("mouseout",hideTooltip),update=>update.attr("d",path),exit=>exit.remove());console.timeEnd("renderCounties");}
function renderStateBorder(michiganState){console.log("Entered renderStateBorder",michiganState)
svg.select("#state-border").datum(michiganState).attr("d",path);d3.select("#bordersLayer").append("path").datum(michiganState).attr("class","state").attr("d",path).attr("id",`state-${michiganState.properties.OBJECTID}`);}
async function refreshData(circleGeoJSONs,radiusInKm,michiganState,worksheet){try{console.log("Entered refreshData");console.time("refreshData");const[summaryData,encodingMap]=await Promise.all([getSummaryDataTable(worksheet),getEncodingMap(worksheet)]);const{detail,x,y,x2,y2}=encodingMap;const detailName=detail.name;const longitudeName=x.name;const latitudeName=y.name;const longitude2Name=x2.name;const latitude2Name=y2.name;const validDotCoordinates=[];const validCircleCoordinates=[];const priorIds=new Set();const newIds=new Set();for(const row of summaryData){const id=row[detailName]?._value;const lat=row[latitudeName]?._value;const lon=row[longitudeName]?._value;if(isValidCoordinate(lat,lon)){validDotCoordinates.push({lat,lon,id});newIds.add(id);}
const lat2=row[latitude2Name]?._value;const lon2=row[longitude2Name]?._value;if(isValidCoordinate(lat2,lon2)){validCircleCoordinates.push({lat2,lon2,id});priorIds.add(id);}}
function isValidCoordinate(lat,lon){return(isFinite(lat)&&isFinite(lon)&&lat>=-90&&lat<=90&&lon>=-180&&lon<=180);}
validDotCoordinates.forEach(item=>{item.existedInPrior=priorIds.has(item.id);});validCircleCoordinates.forEach(item=>{item.closedInNew=!newIds.has(item.id);});const uniqueDotCoordinates=deduplicate(validDotCoordinates,'lat','lon');const uniqueCircleCoordinates=deduplicate(validCircleCoordinates.filter(item=>item.closedInNew),'lat2','lon2');console.timeEnd("refreshData");console.time("All scripts supposedly");renderCircles(uniqueCircleCoordinates,uniqueDotCoordinates,radiusInKm);const dotGeoJSONs=uniqueDotCoordinates.map(({lat,lon})=>createCircleGeoJSON(lat,lon,radiusInKm));calculateAreas(dotGeoJSONs,michiganState);function deduplicate(arr,latKey,lonKey){const map=new Map();for(const item of arr){const key=`${item[latKey]},${item[lonKey]}`;if(!map.has(key))map.set(key,item);}
return Array.from(map.values());}
console.timeEnd("All scripts supposedly");}catch(error){console.error("Error in refreshData:",error);}}
function processCircleData(michiganState){let circleCoordinates=[{lat:0,lon:0}];const radiusInKm=20*1.60934;const circleGeoJSONs=circleCoordinates.map(circle=>createCircleGeoJSON(circle.lat,circle.lon,radiusInKm));console.log("Leading to params")
let worksheet=tableau.extensions.worksheetContent.worksheet;refreshData(circleGeoJSONs,radiusInKm,michiganState,worksheet)}
function calculateAreas(dotGeoJSONs,michiganState){console.log("Entered calculateAreas");console.time("calculateAreas");if(!dotGeoJSONs||dotGeoJSONs.length===0){console.warn("No circles to process.");return;}
const worker=new Worker('../../assets/Worker.js');worker.postMessage({dotGeoJSONs,michiganBoundary:michiganState});worker.onmessage=function(e){if(e.data.type==='results'){console.timeEnd("calculateAreas");console.log("Worker finished processing");const{totalCircleArea,totalIntersectionAreaBeforeUnioning,areaOutsideMap,finalNonOverlappingArea}=e.data.results;console.log(`Total Circle Area: ${totalCircleArea} km²`);console.log(`Overlap Area: ${totalIntersectionAreaBeforeUnioning} km²`);console.log(`Area Outside Map: ${areaOutsideMap} km²`);console.log(`Final Non-Overlapping Area: ${finalNonOverlappingArea} km²`);updateTableauParameters(totalCircleArea,totalIntersectionAreaBeforeUnioning,areaOutsideMap,finalNonOverlappingArea);}else if(e.data.type==='log'){console.log(e.data.message);}};worker.onerror=function(e){console.error("Worker error:",e.message);};}
function renderCircles(circleCoordinates,dotCoordinates,radiusInKm){console.log("Entered render circles")
console.time('446-453 Send data and recieve back data from worker')
console.time('447- 498 Start to termination of circle worker')
console.timeEnd('446-453 Send data and recieve back data from worker')
console.time('Worker visual response')
const dotsLayer=d3.select("#dotsLayer");const circlesLayer=d3.select("#circlesLayer");dotCoordinates=dotCoordinates.map(d=>{const projected=projection([d.lon,d.lat]);return{...d,projected,path:circlePath(d.lat,d.lon,radiusInKm,projection),};});circleCoordinates=circleCoordinates.map(d=>{const projectedCenter=projection([d.lon2,d.lat2]);return{...d,projectedCenter,};});const priorSame=circleCoordinates.filter(d=>!d.closedInNew);const priorClosed=circleCoordinates.filter(d=>d.closedInNew);const currentSame=dotCoordinates.filter(d=>d.existedInPrior);const currentNew=dotCoordinates.filter(d=>!d.existedInPrior);circlesLayer.selectAll(".circle").data([...currentSame,...currentNew].filter(d=>!d.closedInNew)).join("path").attr("class","circle").attr("d",d=>d.path);circlesLayer.selectAll(".center-dot.prior-same").data(priorSame,d=>d.id).join("circle").attr("class","center-dot prior-same").attr("cx",d=>d.projectedCenter[0]).attr("cy",d=>d.projectedCenter[1]);dotsLayer.selectAll(".dot.current-same").data(currentSame,d=>d.id).join("circle").attr("class","dot current-same").attr("cx",d=>d.projected[0]).attr("cy",d=>d.projected[1]);circlesLayer.selectAll(".center-dot.prior-closed").data(priorClosed,d=>d.id).join("circle").attr("class","center-dot prior-closed").attr("cx",d=>d.projectedCenter[0]).attr("cy",d=>d.projectedCenter[1]);dotsLayer.selectAll(".dot.current-new").data(currentNew,d=>d.id).join("circle").attr("class","dot current-new").attr("cx",d=>d.projected[0]).attr("cy",d=>d.projected[1]);console.timeEnd('Worker visual response')
hideLoading();}
function updateTableauParameters(totalCircleArea,totalIntersectionAreaBeforeUnioning,areaOutsideMap,finalNonOverlappingArea){console.log("Entered updateTableauParameters")
let worksheet=tableau.extensions.worksheetContent.worksheet;worksheet.getParametersAsync().then(parameters=>{console.log(parameters)
let totalAreaParameter=parameters.find(param=>param.name==='TotalArea');let overlapAreaParameter=parameters.find(param=>param.name==='OverlapArea');let outsideMapAreaParameter=parameters.find(param=>param.name==='OutsideMapArea');let finalAreaParameter=parameters.find(param=>param.name==='FinalArea');totalAreaParameter.changeValueAsync(parseFloat((totalCircleArea*0.386102).toFixed(2)));overlapAreaParameter.changeValueAsync(parseFloat((totalIntersectionAreaBeforeUnioning*0.386102).toFixed(2)));outsideMapAreaParameter.changeValueAsync(parseFloat((areaOutsideMap*0.386102).toFixed(2)));finalAreaParameter.changeValueAsync(parseFloat((finalNonOverlappingArea*0.386102).toFixed(2)));});}
function zoomed(event){mapGroup.attr("transform",event.transform);}
function showTooltip(event,d){tooltip.transition().duration(200).style("opacity",0.9);tooltip.html(`
                <span class="tooltip-category">ISD NAME:</span> <span class="tooltip-value">${d.properties.NAME}</span><br/>
            `).style("left",(event.pageX+10)+"px").style("top",(event.pageY-28)+"px");const tooltipNode=tooltip.node();const tooltipRect=tooltipNode.getBoundingClientRect();const svgRect=svg.node().getBoundingClientRect();if(tooltipRect.right>svgRect.right){tooltip.style("left",(event.pageX-tooltipRect.width-10)+"px");}
if(tooltipRect.bottom>svgRect.bottom){tooltip.style("top",(event.pageY-tooltipRect.height-10)+"px");}}
function hideTooltip(){tooltip.transition().duration(500).style("opacity",0);}
function circlePath(lat,lon,radius,projection){var intervals=72;var intervalAngle=(360/intervals);var pointsData=[];for(var i=0;i<intervals;i++){pointsData.push(getDestinationPoint(lat,lon,i*intervalAngle,radius));}
if(projection){var pointsData2=[];for(var i in pointsData){pointsData2.push(projection([pointsData[i][1],pointsData[i][0]]));}
return d3.line()(pointsData2)+"Z";}else{return pointsData;}}
function getDestinationPoint(lat,lon,brng,d){var R=6371;var deg2rad=Math.PI/180;var rad2deg=180/Math.PI;brng*=deg2rad;lat*=deg2rad;lon*=deg2rad;var lat2=Math.asin(Math.sin(lat)*Math.cos(d/R)+
Math.cos(lat)*Math.sin(d/R)*Math.cos(brng));var lon2=lon+Math.atan2(Math.sin(brng)*Math.sin(d/R)*Math.cos(lat),Math.cos(d/R)-Math.sin(lat)*Math.sin(lat2));return[lat2*rad2deg,lon2*rad2deg];}
function createCircleGeoJSON(lat,lon,radius){return turf.circle([lon,lat],radius,{steps:64,units:'kilometers'});}
function clickedISD(event,d){const[[x0,y0],[x1,y1]]=path.bounds(d);event.stopPropagation();svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity.translate(width/2,height/2).scale(Math.min(40,0.5/Math.max((x1-x0)/width,(y1-y0)/height))).translate(-(x0+x1)/2,-(y0+y1)/2));}
function reset(){svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity,d3.zoomTransform(svg.node()).invert([width/2,height/2]));}
function Start(){initializeMap();loadData();showLoading();}
(function(){window.onload=tableau.extensions.initializeAsync().then(async()=>{let worksheet=tableau.extensions.worksheetContent.worksheet
worksheet.addEventListener(tableau.TableauEventType.SummaryDataChanged,Start);Start();}).catch((error)=>{console.log(error.stack||error)});})();</script></body></html>