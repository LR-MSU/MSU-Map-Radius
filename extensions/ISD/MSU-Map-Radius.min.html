<!doctype html>
<html lang=en>
<head>
    <meta charset=UTF-8>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <title>Michigan Counties Map</title>
    <style>.circle{fill:#e6e6e6;stroke:#e6e6e6;stroke-width:.5;opacity:1;pointer-events:none}.center-dot,.dot{stroke:#898989;stroke-width:.5;r:3}.center-dot{opacity:.75}.current-same,.prior-same{fill:#59c18f}.prior-closed{fill:#ffffff}.current-new{fill:#684183}.county{fill-opacity:0;stroke:#000000;stroke-width:1px;transition:stroke .3s,stroke-width .3s}body{overflow-y:hidden;overflow-x:hidden}.state{fill:none;stroke:#000000;stroke-width:1px}.tooltip{position:absolute;background-color:#fff;border:1px solid #ddd;padding:10px;pointer-events:none;font-family:Arial,sans-serif;font-size:14px;box-shadow:0 0 10px rgba(0,0,0,.1);opacity:0}.tooltip-category{color:#888;font-weight:700}.tooltip-value{color:#333;font-weight:700}#loading{position:fixed;width:100vw;height:100vh;background:#fff;z-index:1000;display:none;justify-content:center;align-items:center}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.spinner{animation:spin 1s linear infinite}</style>
    <script src=https://d3js.org/d3.v7.min.js></script>
    <script src=https://d3js.org/topojson.v3.min.js></script>
    <script src=https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js></script>
    <script src=../../assets/tableau.extensions.1.latest.js></script>
</head>
<body>
<div id=loading>
    <img src=../../assets/loading.png class=spinner alt=Loading...>
</div>
<svg width=100vw height=100vh>
    <defs>
        <clipPath id=stateClip>
            <path id=state-border></path>
        </clipPath>
    </defs>
    <g id=mapGroup clip-path=url(#stateClip)>
        <g id=dotsLayer></g>
        <g id=bordersLayer></g>
    </g>
</svg>
<div id=tooltip class=tooltip></div>
<script>function showLoading(){d3.select("#loading").style("display","flex")}function hideLoading(){d3.select("#loading").style("display","none")}const svgConst=document.querySelector("svg"),svgRect=svgConst.getBoundingClientRect(),width=svgRect.width,height=svgRect.height,svg=d3.select("svg"),mapGroup=svg.select("#mapGroup"),tooltip=d3.select("#tooltip"),projection=d3.geoMercator().scale(4e3).center([-84.506,44.182]).translate([width/2,height/2]),path=d3.geoPath().projection(projection),zoom=d3.zoom().scaleExtent([1,8]).on("zoom",zoomed);function convertToListOfNamedRows(e){console.time("convertToListOfNamedRows");const{columns:t,data:o}=e,a=t.map((e=>e.fieldName)),n=o.map((e=>Object.fromEntries(a.map(((o,a)=>[o,e[t[a].index]])))));return console.timeEnd("convertToListOfNamedRows"),n}async function getEncodingMap(e){const t=await e.getVisualSpecificationAsync(),o={};if(t.activeMarksSpecificationIndex<0)return o;const a=t.marksSpecifications[t.activeMarksSpecificationIndex];console.time("175-177");for(const e of a.encodings)o[e.id]=e.field;return console.timeEnd("175-177"),o}async function getSummaryDataTable(e){console.time("getSummaryDataTable");const t=await e.getSummaryDataReaderAsync(void 0,{ignoreSelection:!0}),o=[],a=[];for(let e=0;e<t.pageCount;e++)a.push(t.getPageAsync(e));const n=await Promise.all(a);for(const e of n)o.push(...convertToListOfNamedRows(e));return await t.releaseAsync(),console.timeEnd("getSummaryDataTable"),o}function initializeMap(){svg.call(zoom),d3.select("body").on("keydown",(function(e){"Escape"===e.key&&reset()}))}function loadData(){d3.json("michiganGeo.json").then((e=>{const t=topojson.feature(e,e.objects.cb_2015_us_county_20m).features.filter((e=>"26"===e.properties.STATEFP)),o=topojson.feature(e,e.objects.cb_2018_us_state_20m).features.find((e=>"26"===e.properties.STATEFP));renderMap(t,o),processCircleData(o)}))}function renderMap(e,t){renderCounties(e),renderStateBorder(t)}function renderCounties(e){console.log("Rendering counties..."),console.time("renderCounties");d3.select("#bordersLayer").selectAll(".county").data(e,(e=>e.properties.GEOID)).join((e=>e.append("path").attr("class","county").attr("d",path).attr("id",(e=>`county-${e.properties.GEOID}`)).on("click",clickedCounty).on("mouseover",((e,t)=>requestAnimationFrame((()=>showTooltip(e,t))))).on("mousemove",((e,t)=>requestAnimationFrame((()=>showTooltip(e,t))))).on("mouseout",hideTooltip)),(e=>e.attr("d",path)),(e=>e.remove())),console.timeEnd("renderCounties")}function renderStateBorder(e){console.log("Entered renderStateBorder"),svg.select("#state-border").datum(e).attr("d",path),d3.select("#bordersLayer").append("path").datum(e).attr("class","state").attr("d",path).attr("id",`state-${e.properties.GEOID}`)}async function refreshData(e,t,o,a){try{console.log("Entered refreshData"),console.time("refreshData");const[s,i]=await Promise.all([getSummaryDataTable(a),getEncodingMap(a)]),{detail:c,x:l,y:d,x2:p,y2:u}=i,m=c.name,h=l.name,f=d.name,g=p.name,y=u.name,v=[],w=[],A=new Set,M=new Set;for(const j of s){const C=j[m]?._value,S=j[f]?._value,b=j[h]?._value;n(S,b)&&(v.push({lat:S,lon:b,id:C}),M.add(C));const x=j[y]?._value,T=j[g]?._value;n(x,T)&&(w.push({lat2:x,lon2:T,id:C}),A.add(C))}function n(e,t){return isFinite(e)&&isFinite(t)&&e>=-90&&e<=90&&t>=-180&&t<=180}v.forEach((e=>{e.existedInPrior=A.has(e.id)})),w.forEach((e=>{e.closedInNew=!M.has(e.id)}));const k=r(v,"lat","lon"),E=r(w.filter((e=>e.closedInNew)),"lat2","lon2");console.timeEnd("refreshData"),console.time("All scripts supposedly"),renderCircles(E,k,t);function r(e,t,o){const a=new Map;for(const n of e){const e=`${n[t]},${n[o]}`;a.has(e)||a.set(e,n)}return Array.from(a.values())}calculateAreas(k.map((({lat:e,lon:o})=>createCircleGeoJSON(e,o,t))),o),console.timeEnd("All scripts supposedly")}catch(D){console.error("Error in refreshData:",D)}}function processCircleData(e){const t=32.1868,o=[{lat:0,lon:0}].map((e=>createCircleGeoJSON(e.lat,e.lon,t)));console.log("Leading to params");let a=tableau.extensions.worksheetContent.worksheet;refreshData(o,t,e,a)}function calculateAreas(e,t){if(console.log("Entered calculateAreas"),console.time("calculateAreas"),!e||0===e.length)return void console.warn("No circles to process.");const o=new Worker("Worker.js");o.postMessage({dotGeoJSONs:e,michiganBoundary:t}),o.onmessage=function(e){if("results"===e.data.type){console.timeEnd("calculateAreas"),console.log("Worker finished processing");const{totalCircleArea:t,totalIntersectionAreaBeforeUnioning:o,areaOutsideMap:a,finalNonOverlappingArea:n}=e.data.results;console.log(`Total Circle Area: ${t} km²`),console.log(`Overlap Area: ${o} km²`),console.log(`Area Outside Map: ${a} km²`),console.log(`Final Non-Overlapping Area: ${n} km²`),updateTableauParameters(t,o,a,n)}else"log"===e.data.type&&console.log(e.data.message)},o.onerror=function(e){console.error("Worker error:",e.message)}}function renderCircles(e,t,o){console.log("Entered render circles"),console.time("446-453 Send data and recieve back data from worker"),console.time("447- 498 Start to termination of circle worker"),console.timeEnd("446-453 Send data and recieve back data from worker"),console.time("Worker visual response");const a=d3.select("#dotsLayer");t=t.map((e=>{const t=projection([e.lon,e.lat]);return{...e,projected:t,path:circlePath(e.lat,e.lon,o,projection)}}));const n=(e=e.map((e=>{const t=projection([e.lon2,e.lat2]);return{...e,projectedCenter:t}}))).filter((e=>!e.closedInNew)),r=e.filter((e=>e.closedInNew)),s=t.filter((e=>e.existedInPrior)),i=t.filter((e=>!e.existedInPrior));a.selectAll(".circle").data([...s,...i].filter((e=>!e.closedInNew))).join("path").attr("class","circle").attr("d",(e=>e.path)),a.selectAll(".center-dot.prior-same").data(n,(e=>e.id)).join("circle").attr("class","center-dot prior-same").attr("cx",(e=>e.projectedCenter[0])).attr("cy",(e=>e.projectedCenter[1])),a.selectAll(".dot.current-same").data(s,(e=>e.id)).join("circle").attr("class","dot current-same").attr("cx",(e=>e.projected[0])).attr("cy",(e=>e.projected[1])),a.selectAll(".center-dot.prior-closed").data(r,(e=>e.id)).join("circle").attr("class","center-dot prior-closed").attr("cx",(e=>e.projectedCenter[0])).attr("cy",(e=>e.projectedCenter[1])),a.selectAll(".dot.current-new").data(i,(e=>e.id)).join("circle").attr("class","dot current-new").attr("cx",(e=>e.projected[0])).attr("cy",(e=>e.projected[1])),console.timeEnd("Worker visual response"),hideLoading()}function updateTableauParameters(e,t,o,a){console.log("Entered updateTableauParameters"),tableau.extensions.worksheetContent.worksheet.getParametersAsync().then((n=>{console.log(n);let r=n.find((e=>"TotalArea"===e.name)),s=n.find((e=>"OverlapArea"===e.name)),i=n.find((e=>"OutsideMapArea"===e.name)),c=n.find((e=>"FinalArea"===e.name));r.changeValueAsync(parseFloat((.386102*e).toFixed(2))),s.changeValueAsync(parseFloat((.386102*t).toFixed(2))),i.changeValueAsync(parseFloat((.386102*o).toFixed(2))),c.changeValueAsync(parseFloat((.386102*a).toFixed(2)))}))}function zoomed(e){mapGroup.attr("transform",e.transform)}function showTooltip(e,t){tooltip.transition().duration(200).style("opacity",.9),tooltip.html(`\n                <span class="tooltip-category">ISD NAME:</span> <span class="tooltip-value">${t.properties.NAME}</span><br/>\n            `).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px");const o=tooltip.node().getBoundingClientRect(),a=svg.node().getBoundingClientRect();o.right>a.right&&tooltip.style("left",e.pageX-o.width-10+"px"),o.bottom>a.bottom&&tooltip.style("top",e.pageY-o.height-10+"px")}function hideTooltip(){tooltip.transition().duration(500).style("opacity",0)}function circlePath(e,t,o,a){for(var n=[],r=0;r<72;r++)n.push(getDestinationPoint(e,t,5*r,o));if(a){var s=[];for(var r in n)s.push(a([n[r][1],n[r][0]]));return d3.line()(s)+"Z"}return n}function getDestinationPoint(e,t,o,a){var n=6371,r=Math.PI/180,s=180/Math.PI;o*=r,e*=r,t*=r;var i=Math.asin(Math.sin(e)*Math.cos(a/n)+Math.cos(e)*Math.sin(a/n)*Math.cos(o));return[i*s,(t+Math.atan2(Math.sin(o)*Math.sin(a/n)*Math.cos(e),Math.cos(a/n)-Math.sin(e)*Math.sin(i)))*s]}function createCircleGeoJSON(e,t,o){return turf.circle([t,e],o,{steps:64,units:"kilometers"})}function clickedCounty(e,t){const[[o,a],[n,r]]=path.bounds(t);e.stopPropagation(),svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity.translate(width/2,height/2).scale(Math.min(40,.5/Math.max((n-o)/width,(r-a)/height))).translate(-(o+n)/2,-(a+r)/2))}function reset(){svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity,d3.zoomTransform(svg.node()).invert([width/2,height/2]))}function Start(){initializeMap(),loadData(),showLoading()}window.onload=tableau.extensions.initializeAsync().then((async()=>{tableau.extensions.worksheetContent.worksheet.addEventListener(tableau.TableauEventType.SummaryDataChanged,Start),Start()})).catch((e=>{console.log(e.stack||e)}))</script>
</body>
</html>
