<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta content="width=device-width, initial-scale=1.0" name=viewport><title>Michigan Counties Map</title><style>.circle{fill:#e6e6e6;stroke:#e6e6e6;stroke-width:.5;opacity:1;pointer-events:none}.dot,.center-dot{stroke:#898989;stroke-width:.5;r:3}.center-dot{opacity:.75}.prior-same,.current-same{fill:#59c18f}.prior-closed{fill:#fff}.current-new{fill:#684183}.ISD{fill-opacity:0;stroke:#000;stroke-width:1px;transition:stroke .3s,stroke-width .3s}body{overflow-y:hidden;overflow-x:hidden}.state{fill:none;stroke:#000;stroke-width:1px}.tooltip{position:absolute;background-color:white;border:1px solid #ddd;padding:10px;pointer-events:none;font-family:Arial,sans-serif;font-size:14px;box-shadow:0 0 10px rgba(0,0,0,0.1);opacity:0}.tooltip-category{color:#888;font-weight:bold}.tooltip-value{color:#333;font-weight:bold}#loading{position:fixed;width:100vw;height:100vh;background:white;z-index:1000;display:none;justify-content:center;align-items:center}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.spinner{animation:spin 1s linear infinite}#contextMenu{position:fixed;background:#fff;border:1px solid #e0e0e0;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.15);padding:8px;display:none;z-index:1000;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;min-width:220px;font-size:12px}.menu-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;cursor:move;border-bottom:1px solid #e0e0e0;padding-bottom:6px}.menu-header h2{margin:0;font-size:13px;color:#333;font-weight:600}.close-button{background:none;border:none;font-size:16px;cursor:pointer;color:#666;padding:2px 4px;border-radius:3px}.close-button:hover{color:#333;background-color:#f0f0f0}.menu-section{margin-bottom:12px;padding:8px 12px;border-radius:4px;background-color:#fff;border:1px solid #e0e0e0;box-shadow:0 1px 2px rgba(0,0,0,0.05)}.menu-section h3{margin:0 0 8px 0;font-size:11px;color:#666;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding-bottom:4px;border-bottom:1px solid #e0e0e0}.menu-section .menu-item{margin-bottom:8px}.menu-section .menu-item:last-child{margin-bottom:0}.menu-section .menu-item label{display:block;font-size:11px;color:#666;margin-bottom:4px;font-weight:500}.menu-section .menu-item input[type="color"]{width:100%;height:24px;border:1px solid #e0e0e0;border-radius:3px;padding:2px}.menu-section .menu-item input[type="range"]{width:100%;margin:4px 0}.menu-section .menu-item input[type="number"]{width:80px;height:24px;border:1px solid #e0e0e0;border-radius:3px;padding:0 6px;font-size:12px;margin-right:4px}.menu-section .menu-item .unit{font-size:11px;color:#666}.color-picker{width:100%;height:24px;margin-bottom:6px;border:1px solid #e0e0e0;border-radius:3px;padding:2px}.size-slider{width:100%;margin:6px 0;-webkit-appearance:none;height:4px;background:#e0e0e0;border-radius:2px;outline:none}.size-slider::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:#2c5282;border-radius:50%;cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.2)}.confirm-button{width:100%;padding:6px;background:#2c5282;color:white;border:none;border-radius:3px;cursor:pointer;margin-top:8px;font-size:12px;font-weight:500}.confirm-button:hover{background:#2b6cb0}.button-group{display:flex;gap:6px;margin-top:8px}.save-button,.load-button{flex:1;padding:6px;border:1px solid #e0e0e0;border-radius:3px;cursor:pointer;font-weight:500;font-size:12px;background:#fff}.save-button{color:#2c5282;border-color:#2c5282}.save-button:hover{background:#ebf8ff}.load-button{color:#666}.load-button:hover{background:#f5f5f5}.view-button{width:100%;padding:6px;border:1px solid #e0e0e0;border-radius:3px;cursor:pointer;font-weight:500;font-size:12px;background:#fff;color:#666;margin-top:6px}.view-button:hover{background:#f5f5f5}.modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:16px;border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1001;min-width:300px;max-width:400px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e0e0e0}.modal-header h2{margin:0;font-size:14px;color:#333;font-weight:600}.modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:#666;padding:2px 4px;border-radius:3px}.modal-close:hover{color:#333;background-color:#f0f0f0}.settings-list{margin:0;padding:0;list-style:none}.settings-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e0e0e0;font-size:12px}.settings-item:last-child{border-bottom:none}.settings-label{font-weight:500;color:#666}.settings-value{display:flex;align-items:center;gap:8px;color:#333}.color-preview{width:16px;height:16px;border:1px solid #e0e0e0;border-radius:2px}.radius-input{width:80px;height:24px;border:1px solid #e0e0e0;border-radius:3px;padding:0 6px;font-size:12px;margin-right:4px}.radius-unit{font-size:12px;color:#666}</style><script src=https://d3js.org/d3.v7.min.js></script><script src=https://d3js.org/topojson.v3.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js></script><script src=../../assets/tableau.extensions.1.latest.js></script></head><body><div id=loading><img alt=Loading... class=spinner src=../../assets/loading.png></div><svg height=100vh width=100vw><defs><clippath id=stateClip><path id=state-border></path></clippath></defs><g clip-path=url(#stateClip) id=mapGroup><g id=circlesLayer></g><g id=bordersLayer></g><g id=dotsLayer></g></g></svg><div class=tooltip id=tooltip></div><div id=contextMenu><div class=menu-header><h2>Map Settings</h2><button class=close-button>×</button></div><div class=menu-section><h3>Circles</h3><div class=menu-item><label>Color</label><input class=color-picker id=circleColor type=color value=#e6e6e6></div><div class=menu-item><label>Range from Center</label><input class=radius-input id=radiusInput max=100 min=1 step=1 type=number value=20><span class=unit>miles</span></div></div><div class=menu-section><h3>Dots</h3><div class=menu-item><label>Size</label><input class=size-slider id=dotSize max=10 min=1 type=range value=3></div><div class=menu-item><label>Prior Year Only</label><input class=color-picker id=priorClosedDotColor type=color value=#ffffff></div><div class=menu-item><label>Both Years</label><input class=color-picker id=priorSameDotColor type=color value=#59c18f></div><div class=menu-item><label>New This Year</label><input class=color-picker id=currentNewDotColor type=color value=#684183></div></div><button class=confirm-button id=confirmStyles>Confirm Changes</button><div class=button-group><button class=save-button id=saveSettings>Save Settings</button><button class=load-button id=loadSettings>Load Settings</button></div><button class=view-button id=viewSettings>View Saved Settings</button></div><div class=modal id=settingsModal><div class=modal-header><h2>Saved Settings</h2><button class=modal-close>×</button></div><ul class=settings-list><li class=settings-item><span class=settings-label>Circle Color</span><span class=settings-value><div class=color-preview id=savedCircleColor></div><span id=savedCircleColorValue></span></span></li><li class=settings-item><span class=settings-label>Prior Year Only Dots</span><span class=settings-value><div class=color-preview id=savedPriorClosedDotColor></div><span id=savedPriorClosedDotColorValue></span></span></li><li class=settings-item><span class=settings-label>Both Years Dots</span><span class=settings-value><div class=color-preview id=savedPriorSameDotColor></div><span id=savedPriorSameDotColorValue></span></span></li><li class=settings-item><span class=settings-label>New This Year Dots</span><span class=settings-value><div class=color-preview id=savedCurrentNewDotColor></div><span id=savedCurrentNewDotColorValue></span></span></li><li class=settings-item><span class=settings-label>Dot Size</span><span class=settings-value id=savedDotSize></span></li></ul></div><script>function showLoading(){d3.select("#loading").style("display","flex");}
function hideLoading(){d3.select("#loading").style("display","none");}
const svgConst=document.querySelector('svg');const svgRect=svgConst.getBoundingClientRect();const width=svgRect.width;const height=svgRect.height;const svg=d3.select("svg");const mapGroup=svg.select("#mapGroup");const tooltip=d3.select("#tooltip");let customizationState={circleColor:"#e6e6e6",priorClosedDotColor:"#ffffff",priorSameDotColor:"#59c18f",currentNewDotColor:"#684183",dotSize:3,radiusInMiles:20};let savedState={circleColor:"#e6e6e6",priorClosedDotColor:"#ffffff",priorSameDotColor:"#59c18f",currentNewDotColor:"#684183",dotSize:3,radiusInMiles:20};const contextMenu=d3.select("#contextMenu");const circleColorPicker=d3.select("#circleColor");const priorClosedDotColorPicker=d3.select("#priorClosedDotColor");const priorSameDotColorPicker=d3.select("#priorSameDotColor");const currentNewDotColorPicker=d3.select("#currentNewDotColor");const dotSizeSlider=d3.select("#dotSize");const radiusInput=d3.select("#radiusInput");const confirmButton=d3.select("#confirmStyles");const closeButton=d3.select(".close-button");const menuHeader=d3.select(".menu-header");const saveButton=d3.select("#saveSettings");const loadButton=d3.select("#loadSettings");const viewButton=d3.select("#viewSettings");const settingsModal=d3.select("#settingsModal");const modalCloseButton=d3.select(".modal-close");async function saveSettingsToTableau(){try{await tableau.extensions.settings.saveAsync();console.log("Settings saved successfully");}catch(error){console.error("Error saving settings:",error);}}
async function saveSettings(){try{Object.keys(customizationState).forEach(key=>{savedState[key]=customizationState[key];});Object.entries(savedState).forEach(([key,value])=>{tableau.extensions.settings.set(key,value.toString());});await saveSettingsToTableau();}catch(error){console.error("Error saving settings:",error);}}
function loadSettings(){try{Object.keys(savedState).forEach(key=>{const tableauValue=tableau.extensions.settings.get(key);if(tableauValue){savedState[key]=key.includes('Size')?parseInt(tableauValue):tableauValue;}});Object.keys(customizationState).forEach(key=>{customizationState[key]=savedState[key];});circleColorPicker.property('value',customizationState.circleColor);priorClosedDotColorPicker.property('value',customizationState.priorClosedDotColor);priorSameDotColorPicker.property('value',customizationState.priorSameDotColor);currentNewDotColorPicker.property('value',customizationState.currentNewDotColor);dotSizeSlider.property('value',customizationState.dotSize);radiusInput.property('value',customizationState.radiusInMiles);if(window.currentCircleCoordinates&&window.currentDotCoordinates&&window.currentRadiusInKm){renderCircles(window.currentCircleCoordinates,window.currentDotCoordinates,window.currentRadiusInKm);}}catch(error){console.error("Error loading settings:",error);}}
saveButton.on("click",saveSettings);loadButton.on("click",loadSettings);let isDragging=false;let dragOffset={x:0,y:0};menuHeader.on("mousedown",function(event){isDragging=true;const menuRect=contextMenu.node().getBoundingClientRect();dragOffset.x=event.clientX-menuRect.left;dragOffset.y=event.clientY-menuRect.top;event.preventDefault();});d3.select("body").on("mousemove",function(event){if(isDragging){contextMenu.style("left",(event.clientX-dragOffset.x)+"px").style("top",(event.clientY-dragOffset.y)+"px");}});d3.select("body").on("mouseup",function(){isDragging=false;});closeButton.on("click",function(){contextMenu.style("display","none");});d3.select("body").on("click",function(event){const target=event.target;const isContextMenu=contextMenu.node().contains(target);if(!isContextMenu){contextMenu.style("display","none");}});svg.on("contextmenu",null);circleColorPicker.on("change",function(){customizationState.circleColor=this.value;});priorClosedDotColorPicker.on("change",function(){customizationState.priorClosedDotColor=this.value;});priorSameDotColorPicker.on("change",function(){customizationState.priorSameDotColor=this.value;});currentNewDotColorPicker.on("change",function(){customizationState.currentNewDotColor=this.value;});dotSizeSlider.on("input",function(){customizationState.dotSize=this.value;});radiusInput.on("change",function(){const value=parseInt(this.value);if(value>=1&&value<=100){customizationState.radiusInMiles=value;}else{this.value=customizationState.radiusInMiles;}});confirmButton.on("click",function(){const radiusInKm=customizationState.radiusInMiles*1.60934;if(window.currentCircleCoordinates&&window.currentDotCoordinates){renderCircles(window.currentCircleCoordinates,window.currentDotCoordinates,radiusInKm);const dotGeoJSONs=window.currentDotCoordinates.map(({lat,lon})=>createCircleGeoJSON(lat,lon,radiusInKm));const michiganState=d3.select("#state-border").datum();calculateAreas(dotGeoJSONs,michiganState);}});const projection=d3.geoMercator().scale(4000).center([-84.506,44.182]).translate([width/2,height/2]);const path=d3.geoPath().projection(projection);const zoom=d3.zoom().scaleExtent([1,8]).on("zoom",zoomed);function convertToListOfNamedRows(dataTablePage){console.time('convertToListOfNamedRows');const{columns,data}=dataTablePage;const columnMap=columns.map(col=>col.fieldName);const rows=data.map(row=>Object.fromEntries(columnMap.map((key,index)=>[key,row[columns[index].index]])));console.timeEnd('convertToListOfNamedRows');return rows;}
async function getEncodingMap(worksheet){const visualSpec=await worksheet.getVisualSpecificationAsync();const encodingMap={};if(visualSpec.activeMarksSpecificationIndex<0)return encodingMap;const marksCard=visualSpec.marksSpecifications[visualSpec.activeMarksSpecificationIndex];console.time('175-177')
for(const encoding of marksCard.encodings){encodingMap[encoding.id]=encoding.field;}
console.timeEnd('175-177')
return encodingMap;}
async function getSummaryDataTable(worksheet){console.time('getSummaryDataTable');const dataTableReader=await worksheet.getSummaryDataReaderAsync(undefined,{ignoreSelection:true});const rows=[];const pagePromises=[];for(let currentPage=0;currentPage<dataTableReader.pageCount;currentPage++){pagePromises.push(dataTableReader.getPageAsync(currentPage));}
const pages=await Promise.all(pagePromises);for(const dataTablePage of pages){rows.push(...convertToListOfNamedRows(dataTablePage));}
await dataTableReader.releaseAsync();console.timeEnd('getSummaryDataTable');return rows;}
function initializeMap(){svg.call(zoom);d3.select("body").on("keydown",function(event){if(event.key==="Escape"){reset();}});}
function loadData(){d3.json("../../assets/michiganISDGeo.json").then(data=>{const michiganState=data.features.find(d=>{return d.properties.NAME==="michigan_Merged";})
const michiganCounties=data.features.filter(d=>{return d.properties.TYPE==="ISD";});renderMap(michiganCounties,michiganState);processCircleData(michiganState);});}
function renderMap(michiganCounties,michiganState){renderCounties(michiganCounties);renderStateBorder(michiganState);}
function renderCounties(michiganCounties){console.log("Rendering counties...");console.time("renderCounties");const bordersLayer=d3.select("#bordersLayer");bordersLayer.selectAll(".ISD").data(michiganCounties,d=>d.properties.OBJECTID).join(enter=>enter.append("path").attr("class","ISD").attr("d",path).attr("id",d=>`ISD-${d.properties.OBJECTID}`).on("click",clickedISD).on("mouseover",(event,d)=>requestAnimationFrame(()=>showTooltip(event,d))).on("mousemove",(event,d)=>requestAnimationFrame(()=>showTooltip(event,d))).on("mouseout",hideTooltip),update=>update.attr("d",path),exit=>exit.remove());console.timeEnd("renderCounties");}
function renderStateBorder(michiganState){console.log("Entered renderStateBorder")
svg.select("#state-border").datum(michiganState).attr("d",path);d3.select("#bordersLayer").append("path").datum(michiganState).attr("class","state").attr("d",path).attr("id",`state-${michiganState.properties.OBJECTID}`);}
async function refreshData(circleGeoJSONs,radiusInKm,michiganState,worksheet){try{console.log("Entered refreshData");console.time("refreshData");const[summaryData,encodingMap]=await Promise.all([getSummaryDataTable(worksheet),getEncodingMap(worksheet)]);const{detail,x,y,x2,y2}=encodingMap;const detailName=detail.name;const longitudeName=x.name;const latitudeName=y.name;const longitude2Name=x2.name;const latitude2Name=y2.name;const validDotCoordinates=[];const validCircleCoordinates=[];const priorIds=new Set();const newIds=new Set();for(const row of summaryData){const id=row[detailName]?._value;const lat=row[latitudeName]?._value;const lon=row[longitudeName]?._value;if(isValidCoordinate(lat,lon)){validDotCoordinates.push({lat,lon,id});newIds.add(id);}
const lat2=row[latitude2Name]?._value;const lon2=row[longitude2Name]?._value;if(isValidCoordinate(lat2,lon2)){validCircleCoordinates.push({lat2,lon2,id});priorIds.add(id);}}
function isValidCoordinate(lat,lon){return(isFinite(lat)&&isFinite(lon)&&lat>=-90&&lat<=90&&lon>=-180&&lon<=180);}
validDotCoordinates.forEach(item=>{item.existedInPrior=priorIds.has(item.id);});validCircleCoordinates.forEach(item=>{item.closedInNew=!newIds.has(item.id);});const uniqueDotCoordinates=deduplicate(validDotCoordinates,'lat','lon');const uniqueCircleCoordinates=deduplicate(validCircleCoordinates.filter(item=>item.closedInNew),'lat2','lon2');console.timeEnd("refreshData");console.time("All scripts supposedly");renderCircles(uniqueCircleCoordinates,uniqueDotCoordinates,radiusInKm);const dotGeoJSONs=uniqueDotCoordinates.map(({lat,lon})=>createCircleGeoJSON(lat,lon,radiusInKm));calculateAreas(dotGeoJSONs,michiganState);function deduplicate(arr,latKey,lonKey){const map=new Map();for(const item of arr){const key=`${item[latKey]},${item[lonKey]}`;if(!map.has(key))map.set(key,item);}
return Array.from(map.values());}
console.timeEnd("All scripts supposedly");}catch(error){console.error("Error in refreshData:",error);}}
function processCircleData(michiganState){let circleCoordinates=[{lat:0,lon:0}];const radiusInMiles=customizationState.radiusInMiles;const radiusInKm=radiusInMiles*1.60934;const circleGeoJSONs=circleCoordinates.map(circle=>createCircleGeoJSON(circle.lat,circle.lon,radiusInKm));console.log("Leading to params")
let worksheet=tableau.extensions.worksheetContent.worksheet;refreshData(circleGeoJSONs,radiusInKm,michiganState,worksheet)}
function calculateAreas(dotGeoJSONs,michiganState){console.log("Entered calculateAreas");console.time("calculateAreas");if(!dotGeoJSONs||dotGeoJSONs.length===0){console.warn("No circles to process.");return;}
const worker=new Worker('../../assets/Worker.js');worker.postMessage({dotGeoJSONs,michiganBoundary:michiganState});worker.onmessage=function(e){if(e.data.type==='results'){console.timeEnd("calculateAreas");console.log("Worker finished processing");const{totalCircleArea,totalIntersectionAreaBeforeUnioning,areaOutsideMap,finalNonOverlappingArea}=e.data.results;console.log(`Total Circle Area: ${totalCircleArea} km²`);console.log(`Overlap Area: ${totalIntersectionAreaBeforeUnioning} km²`);console.log(`Area Outside Map: ${areaOutsideMap} km²`);console.log(`Final Non-Overlapping Area: ${finalNonOverlappingArea} km²`);updateTableauParameters(totalCircleArea,totalIntersectionAreaBeforeUnioning,areaOutsideMap,finalNonOverlappingArea);}else if(e.data.type==='log'){console.log(e.data.message);}};worker.onerror=function(e){console.error("Worker error:",e.message);};}
function renderCircles(circleCoordinates,dotCoordinates,radiusInKm){console.log("Entered render circles")
console.time('446-453 Send data and recieve back data from worker')
console.time('447- 498 Start to termination of circle worker')
window.currentCircleCoordinates=circleCoordinates;window.currentDotCoordinates=dotCoordinates;window.currentRadiusInKm=radiusInKm;console.timeEnd('446-453 Send data and recieve back data from worker')
console.time('Worker visual response')
const dotsLayer=d3.select("#dotsLayer");const circlesLayer=d3.select("#circlesLayer");dotCoordinates=dotCoordinates.map(d=>{const projected=projection([d.lon,d.lat]);return{...d,projected,path:circlePath(d.lat,d.lon,radiusInKm,projection),};});circleCoordinates=circleCoordinates.map(d=>{const projectedCenter=projection([d.lon2,d.lat2]);return{...d,projectedCenter,};});const priorSame=circleCoordinates.filter(d=>!d.closedInNew);const priorClosed=circleCoordinates.filter(d=>d.closedInNew);const currentSame=dotCoordinates.filter(d=>d.existedInPrior);const currentNew=dotCoordinates.filter(d=>!d.existedInPrior);circlesLayer.selectAll(".circle").data([...currentSame,...currentNew].filter(d=>!d.closedInNew)).join("path").attr("class","circle").attr("d",d=>d.path).style("fill",customizationState.circleColor).style("stroke",customizationState.circleColor);circlesLayer.selectAll(".center-dot.prior-same").data(priorSame,d=>d.id).join("circle").attr("class","center-dot prior-same").attr("cx",d=>d.projectedCenter[0]).attr("cy",d=>d.projectedCenter[1]).style("fill",customizationState.priorSameDotColor).style("r",customizationState.dotSize);dotsLayer.selectAll(".dot.current-same").data(currentSame,d=>d.id).join("circle").attr("class","dot current-same").attr("cx",d=>d.projected[0]).attr("cy",d=>d.projected[1]).style("fill",customizationState.priorSameDotColor).style("r",customizationState.dotSize);circlesLayer.selectAll(".center-dot.prior-closed").data(priorClosed,d=>d.id).join("circle").attr("class","center-dot prior-closed").attr("cx",d=>d.projectedCenter[0]).attr("cy",d=>d.projectedCenter[1]).style("fill",customizationState.priorClosedDotColor).style("r",customizationState.dotSize);dotsLayer.selectAll(".dot.current-new").data(currentNew,d=>d.id).join("circle").attr("class","dot current-new").attr("cx",d=>d.projected[0]).attr("cy",d=>d.projected[1]).style("fill",customizationState.currentNewDotColor).style("r",customizationState.dotSize);console.timeEnd('Worker visual response')
hideLoading();}
function updateTableauParameters(totalCircleArea,totalIntersectionAreaBeforeUnioning,areaOutsideMap,finalNonOverlappingArea){console.log("Entered updateTableauParameters")
let worksheet=tableau.extensions.worksheetContent.worksheet;worksheet.getParametersAsync().then(parameters=>{console.log(parameters)
let totalAreaParameter=parameters.find(param=>param.name==='TotalArea');let overlapAreaParameter=parameters.find(param=>param.name==='OverlapArea');let outsideMapAreaParameter=parameters.find(param=>param.name==='OutsideMapArea');let finalAreaParameter=parameters.find(param=>param.name==='FinalArea');totalAreaParameter.changeValueAsync(parseFloat((totalCircleArea*0.386102).toFixed(2)));overlapAreaParameter.changeValueAsync(parseFloat((totalIntersectionAreaBeforeUnioning*0.386102).toFixed(2)));outsideMapAreaParameter.changeValueAsync(parseFloat((areaOutsideMap*0.386102).toFixed(2)));finalAreaParameter.changeValueAsync(parseFloat((finalNonOverlappingArea*0.386102).toFixed(2)));});}
function zoomed(event){mapGroup.attr("transform",event.transform);}
function showTooltip(event,d){tooltip.transition().duration(200).style("opacity",0.9);tooltip.html(`
                <span class="tooltip-category">ISD NAME:</span> <span class="tooltip-value">${d.properties.NAME}</span><br/>
            `).style("left",(event.pageX+10)+"px").style("top",(event.pageY-28)+"px");const tooltipNode=tooltip.node();const tooltipRect=tooltipNode.getBoundingClientRect();const svgRect=svg.node().getBoundingClientRect();if(tooltipRect.right>svgRect.right){tooltip.style("left",(event.pageX-tooltipRect.width-10)+"px");}
if(tooltipRect.bottom>svgRect.bottom){tooltip.style("top",(event.pageY-tooltipRect.height-10)+"px");}}
function hideTooltip(){tooltip.transition().duration(500).style("opacity",0);}
function circlePath(lat,lon,radius,projection){var intervals=72;var intervalAngle=(360/intervals);var pointsData=[];for(var i=0;i<intervals;i++){pointsData.push(getDestinationPoint(lat,lon,i*intervalAngle,radius));}
if(projection){var pointsData2=[];for(var i in pointsData){pointsData2.push(projection([pointsData[i][1],pointsData[i][0]]));}
return d3.line()(pointsData2)+"Z";}else{return pointsData;}}
function getDestinationPoint(lat,lon,brng,d){var R=6371;var deg2rad=Math.PI/180;var rad2deg=180/Math.PI;brng*=deg2rad;lat*=deg2rad;lon*=deg2rad;var lat2=Math.asin(Math.sin(lat)*Math.cos(d/R)+
Math.cos(lat)*Math.sin(d/R)*Math.cos(brng));var lon2=lon+Math.atan2(Math.sin(brng)*Math.sin(d/R)*Math.cos(lat),Math.cos(d/R)-Math.sin(lat)*Math.sin(lat2));return[lat2*rad2deg,lon2*rad2deg];}
function createCircleGeoJSON(lat,lon,radius){return turf.circle([lon,lat],radius,{steps:64,units:'kilometers'});}
function clickedISD(event,d){const[[x0,y0],[x1,y1]]=path.bounds(d);event.stopPropagation();svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity.translate(width/2,height/2).scale(Math.min(40,0.5/Math.max((x1-x0)/width,(y1-y0)/height))).translate(-(x0+x1)/2,-(y0+y1)/2));}
function reset(){svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity,d3.zoomTransform(svg.node()).invert([width/2,height/2]));}
function hasSavedSettings(){return Object.keys(savedState).some(key=>tableau.extensions.settings.get(key)!==undefined);}
function Start(){initializeMap();loadData();showLoading();setTimeout(()=>{if(hasSavedSettings()){console.log("Found saved settings, applying automatically...");Object.keys(savedState).forEach(key=>{const tableauValue=tableau.extensions.settings.get(key);if(tableauValue){savedState[key]=key.includes('Size')?parseInt(tableauValue):tableauValue;}});loadSettings();}},1000);}
(function(){window.onload=tableau.extensions.initializeAsync({'configure':showSettingsMenu}).then(async()=>{let worksheet=tableau.extensions.worksheetContent.worksheet
worksheet.addEventListener(tableau.TableauEventType.SummaryDataChanged,Start);Start();}).catch((error)=>{console.log(error.stack||error)});})();function showSettingsMenu(){const menuWidth=220;const menuHeight=350;contextMenu.style("left",(window.innerWidth/2-menuWidth/2)+"px").style("top",(window.innerHeight/2-menuHeight/2)+"px").style("display","block");}
function updateSettingsModal(){try{Object.keys(savedState).forEach(key=>{const savedValue=savedState[key];if(key.includes('Color')){d3.select(`#saved${key.charAt(0).toUpperCase() + key.slice(1)}`).style('background-color',savedValue);d3.select(`#saved${key.charAt(0).toUpperCase() + key.slice(1)}Value`).text(savedValue);}else if(key==='dotSize'){d3.select(`#saved${key.charAt(0).toUpperCase() + key.slice(1)}`).text(savedValue);}});}catch(error){console.error("Error updating settings modal:",error);}}
viewButton.on("click",function(){updateSettingsModal();settingsModal.style("display","block");});modalCloseButton.on("click",function(){settingsModal.style("display","none");});d3.select("body").on("click",function(event){const target=event.target;const isModal=settingsModal.node().contains(target);const isViewButton=viewButton.node().contains(target);if(!isModal&&!isViewButton&&settingsModal.style("display")!=="none"){settingsModal.style("display","none");}});</script></body></html>