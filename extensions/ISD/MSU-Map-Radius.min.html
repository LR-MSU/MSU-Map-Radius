<!doctypehtml><html lang=en><meta charset=UTF-8><meta content="width=device-width,initial-scale=1"name=viewport><title>Michigan Counties Map</title><style>.circle{fill:#e6e6e6;stroke:#e6e6e6;stroke-width:.5;opacity:1;pointer-events:none}.center-dot,.dot{stroke:#898989;stroke-width:.5}.center-dot{opacity:.75}.current-same,.prior-same{fill:#59c18f}.prior-closed{fill:#fff}.current-new{fill:#684183}.ISD{fill-opacity:0;stroke:#000;stroke-width:1px;transition:stroke .3s,stroke-width .3s}body{overflow-y:hidden;overflow-x:hidden}.state{fill:none;stroke:#000;stroke-width:1px}.tooltip{position:absolute;background-color:#fff;border:1px solid #ddd;padding:10px;pointer-events:none;font-family:Arial,sans-serif;font-size:14px;box-shadow:0 0 10px rgba(0,0,0,.1);opacity:0}.tooltip-category{color:#888;font-weight:700}.tooltip-value{color:#333;font-weight:700}#loading{position:fixed;width:100vw;height:100vh;background:#fff;z-index:1000;display:none;justify-content:center;align-items:center}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.spinner{animation:spin 1s linear infinite}</style><script src=https://d3js.org/d3.v7.min.js></script><script src=https://d3js.org/topojson.v3.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js></script><script src=../../assets/tableau.extensions.1.latest.js></script><div id=loading><img alt=Loading... class=spinner src=../../assets/loading.png></div><svg height=100vh width=100vw><defs><clipPath id=stateClip><path id=state-border></path></clipPath></defs><g id=mapGroup clip-path=url(#stateClip)><g id=dotsLayer></g><g id=bordersLayer></g></g></svg><div id=tooltip class=tooltip></div><script>
    function showLoading(){d3.select("#loading").style("display","flex")}function hideLoading(){d3.select("#loading").style("display","none")}const svgConst=document.querySelector("svg"),svgRect=svgConst.getBoundingClientRect(),width=svgRect.width,height=svgRect.height,svg=d3.select("svg"),mapGroup=svg.select("#mapGroup"),tooltip=d3.select("#tooltip"),projection=d3.geoMercator().scale(4e3).center([-84.506,44.182]).translate([width/2,height/2]),path=d3.geoPath().projection(projection),zoom=d3.zoom().scaleExtent([1,8]).on("zoom",zoomed);function convertToListOfNamedRows(e){console.time("convertToListOfNamedRows");let{columns:t,data:a}=e,r=t.map(e=>e.fieldName),o=a.map(e=>Object.fromEntries(r.map((a,r)=>[a,e[t[r].index]])));return console.timeEnd("convertToListOfNamedRows"),o}async function getEncodingMap(e){let t=await e.getVisualSpecificationAsync(),a={};if(t.activeMarksSpecificationIndex<0)return a;let r=t.marksSpecifications[t.activeMarksSpecificationIndex];for(let o of(console.time("175-177"),r.encodings))a[o.id]=o.field;return console.timeEnd("175-177"),a}async function getSummaryDataTable(e){console.time("getSummaryDataTable");let t=await e.getSummaryDataReaderAsync(void 0,{ignoreSelection:!0}),a=[],r=[];for(let o=0;o<t.pageCount;o++)r.push(t.getPageAsync(o));let n=await Promise.all(r);for(let i of n)a.push(...convertToListOfNamedRows(i));return await t.releaseAsync(),console.timeEnd("getSummaryDataTable"),a}function initializeMap(){svg.call(zoom),d3.select("body").on("keydown",function(e){"Escape"===e.key&&reset()})}function loadData(){d3.json("../../assets/michiganISDGeo.json").then(e=>{let t=e.features.find(e=>"michigan_Merged"===e.properties.NAME),a=e.features.filter(e=>"ISD"===e.properties.TYPE);renderMap(a,t),processCircleData(t)})}function renderMap(e,t){renderCounties(e),renderStateBorder(t)}function renderCounties(e){console.log("Rendering counties..."),console.time("renderCounties");let t=d3.select("#bordersLayer");t.selectAll(".ISD").data(e,e=>e.properties.OBJECTID).join(e=>e.append("path").attr("class","ISD").attr("d",path).attr("id",e=>`ISD-${e.properties.OBJECTID}`).on("click",clickedISD).on("mouseover",(e,t)=>requestAnimationFrame(()=>showTooltip(e,t))).on("mousemove",(e,t)=>requestAnimationFrame(()=>showTooltip(e,t))).on("mouseout",hideTooltip),e=>e.attr("d",path),e=>e.remove()),console.timeEnd("renderCounties")}function renderStateBorder(e){console.log("Entered renderStateBorder"),svg.select("#state-border").datum(e).attr("d",path),d3.select("#bordersLayer").append("path").datum(e).attr("class","state").attr("d",path).attr("id",`state-${e.properties.OBJECTID}`)}async function refreshData(e,t,a,r){try{console.log("Entered refreshData"),console.time("refreshData");let[o,n]=await Promise.all([getSummaryDataTable(r),getEncodingMap(r)]),{detail:i,x:s,y:l,x2:c,y2:d}=n,p=i.name,u=s.name,m=l.name,g=c.name,f=d.name,h=[],y=[],v=new Set,$=new Set;for(let w of o){let A=w[p]?._value,S=w[m]?._value,E=w[u]?._value;D(S,E)&&(h.push({lat:S,lon:E,id:A}),$.add(A));let k=w[f]?._value,C=w[g]?._value;D(k,C)&&(y.push({lat2:k,lon2:C,id:A}),v.add(A))}function D(e,t){return isFinite(e)&&isFinite(t)&&e>=-90&&e<=90&&t>=-180&&t<=180}h.forEach(e=>{e.existedInPrior=v.has(e.id)}),y.forEach(e=>{e.closedInNew=!$.has(e.id)});let _=T(h,"lat","lon"),x=T(y.filter(e=>e.closedInNew),"lat2","lon2");console.timeEnd("refreshData"),console.time("All scripts supposedly"),renderCircles(x,_,t);let I=_.map(({lat:e,lon:a})=>createCircleGeoJSON(e,a,t));function T(e,t,a){let r=new Map;for(let o of e){let n=`${o[t]},${o[a]}`;r.has(n)||r.set(n,o)}return Array.from(r.values())}calculateAreas(I,a),console.timeEnd("All scripts supposedly")}catch(j){console.error("Error in refreshData:",j)}}function processCircleData(e){let t=[{lat:0,lon:0}].map(e=>createCircleGeoJSON(e.lat,e.lon,32.1868));console.log("Leading to params");refreshData(t,32.1868,e,tableau.extensions.worksheetContent.worksheet)}function calculateAreas(e,t){if(console.log("Entered calculateAreas"),console.time("calculateAreas"),!e||0===e.length){console.warn("No circles to process.");return}let a=new Worker("../../assets/Worker.js");a.postMessage({dotGeoJSONs:e,michiganBoundary:t}),a.onmessage=function(e){if("results"===e.data.type){console.timeEnd("calculateAreas"),console.log("Worker finished processing");let{totalCircleArea:t,totalIntersectionAreaBeforeUnioning:a,areaOutsideMap:r,finalNonOverlappingArea:o}=e.data.results;console.log(`Total Circle Area: ${t} km\xb2`),console.log(`Overlap Area: ${a} km\xb2`),console.log(`Area Outside Map: ${r} km\xb2`),console.log(`Final Non-Overlapping Area: ${o} km\xb2`),updateTableauParameters(t,a,r,o)}else"log"===e.data.type&&console.log(e.data.message)},a.onerror=function(e){console.error("Worker error:",e.message)}}function renderCircles(e,t,a){console.log("Entered render circles"),console.time("446-453 Send data and recieve back data from worker"),console.time("447- 498 Start to termination of circle worker"),console.timeEnd("446-453 Send data and recieve back data from worker"),console.time("Worker visual response");let r=d3.select("#dotsLayer");t=t.map(e=>{let t=projection([e.lon,e.lat]);return{...e,projected:t,path:circlePath(e.lat,e.lon,a,projection)}}),e=e.map(e=>{let t=projection([e.lon2,e.lat2]);return{...e,projectedCenter:t}});let o=e.filter(e=>!e.closedInNew),n=e.filter(e=>e.closedInNew),i=t.filter(e=>e.existedInPrior),s=t.filter(e=>!e.existedInPrior);r.selectAll(".circle").data([...i,...s].filter(e=>!e.closedInNew)).join("path").attr("class","circle").attr("d",e=>e.path),r.selectAll(".center-dot.prior-same").data(o,e=>e.id).join("circle").attr("class","center-dot prior-same").attr("cx",e=>e.projectedCenter[0]).attr("cy",e=>e.projectedCenter[1]),r.selectAll(".dot.current-same").data(i,e=>e.id).join("circle").attr("class","dot current-same").attr("cx",e=>e.projected[0]).attr("cy",e=>e.projected[1]),r.selectAll(".center-dot.prior-closed").data(n,e=>e.id).join("circle").attr("class","center-dot prior-closed").attr("cx",e=>e.projectedCenter[0]).attr("cy",e=>e.projectedCenter[1]),r.selectAll(".dot.current-new").data(s,e=>e.id).join("circle").attr("class","dot current-new").attr("cx",e=>e.projected[0]).attr("cy",e=>e.projected[1]),console.timeEnd("Worker visual response"),hideLoading()}function updateTableauParameters(e,t,a,r){console.log("Entered updateTableauParameters");tableau.extensions.worksheetContent.worksheet.getParametersAsync().then(o=>{console.log(o);let n=o.find(e=>"TotalArea"===e.name),i=o.find(e=>"OverlapArea"===e.name),s=o.find(e=>"OutsideMapArea"===e.name),l=o.find(e=>"FinalArea"===e.name);n.changeValueAsync(parseFloat((.386102*e).toFixed(2))),i.changeValueAsync(parseFloat((.386102*t).toFixed(2))),s.changeValueAsync(parseFloat((.386102*a).toFixed(2))),l.changeValueAsync(parseFloat((.386102*r).toFixed(2)))})}function zoomed(e){mapGroup.attr("transform",e.transform)}function showTooltip(e,t){tooltip.transition().duration(200).style("opacity",.9),tooltip.html(`
                <span class="tooltip-category">ISD NAME:</span> <span class="tooltip-value">${t.properties.NAME}</span><br/>
            `).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px");let a=tooltip.node(),r=a.getBoundingClientRect(),o=svg.node().getBoundingClientRect();r.right>o.right&&tooltip.style("left",e.pageX-r.width-10+"px"),r.bottom>o.bottom&&tooltip.style("top",e.pageY-r.height-10+"px")}function hideTooltip(){tooltip.transition().duration(500).style("opacity",0)}function circlePath(e,t,a,r){for(var o=[],n=0;n<72;n++)o.push(getDestinationPoint(e,t,5*n,a));if(!r)return o;var i=[];for(var n in o)i.push(r([o[n][1],o[n][0]]));return d3.line()(i)+"Z"}function getDestinationPoint(e,t,a,r){var o=Math.PI/180,n=180/Math.PI;a*=o;var i=Math.asin(Math.sin(e*=o)*Math.cos(r/6371)+Math.cos(e)*Math.sin(r/6371)*Math.cos(a)),s=(t*=o)+Math.atan2(Math.sin(a)*Math.sin(r/6371)*Math.cos(e),Math.cos(r/6371)-Math.sin(e)*Math.sin(i));return[i*n,s*n]}function createCircleGeoJSON(e,t,a){return turf.circle([t,e],a,{steps:64,units:"kilometers"})}function clickedISD(e,t){let[[a,r],[o,n]]=path.bounds(t);e.stopPropagation(),svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity.translate(width/2,height/2).scale(Math.min(40,.5/Math.max((o-a)/width,(n-r)/height))).translate(-(a+o)/2,-(r+n)/2))}function reset(){svg.transition().duration(750).call(zoom.transform,d3.zoomIdentity,d3.zoomTransform(svg.node()).invert([width/2,height/2]))}function Start(){initializeMap(),loadData(),showLoading()}window.onload=tableau.extensions.initializeAsync().then(async()=>{tableau.extensions.worksheetContent.worksheet.addEventListener(tableau.TableauEventType.SummaryDataChanged,Start),Start()}).catch(e=>{console.log(e.stack||e)});</script></body></html>
